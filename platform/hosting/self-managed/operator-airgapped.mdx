---
description: Deploy W&B Platform with Kubernetes Operator (Airgapped)
title: Kubernetes operator for air-gapped instances
---

import SelfManagedVersionRequirements from "/snippets/_includes/self-managed-version-requirements.mdx";
import SelfManagedSslTlsRequirements from "/snippets/_includes/self-managed-ssl-tls-requirements.mdx";
import SelfManagedMysqlRequirements from "/snippets/_includes/self-managed-mysql-requirements.mdx";
import SelfManagedMysqlDatabaseCreation from "/snippets/_includes/self-managed-mysql-database-creation.mdx";
import SelfManagedRedisRequirements from "/snippets/_includes/self-managed-redis-requirements.mdx";
import SelfManagedObjectStorageRequirements from "/snippets/_includes/self-managed-object-storage-requirements.mdx";
import SelfManagedHardwareRequirements from "/snippets/_includes/self-managed-hardware-requirements.mdx";
import SelfManagedVerifyInstallation from "/snippets/_includes/self-managed-verify-installation.mdx";

## Introduction

This guide provides step-by-step instructions to deploy the W&B Platform in air-gapped customer-managed environments. 

Use an internal repository or registry to host the Helm charts and container images. Run all commands in a shell console with proper access to the Kubernetes cluster.

You could utilize similar commands in any continuous delivery tooling that you use to deploy Kubernetes applications.

## Step 1: Prerequisites

Before starting, make sure your environment meets the following requirements:

### Version Requirements
<SelfManagedVersionRequirements/>

### SSL/TLS Requirements
<SelfManagedSslTlsRequirements/>

### Hardware Requirements

<SelfManagedHardwareRequirements/>

### MySQL Database

<SelfManagedMysqlRequirements/>

### Redis

<SelfManagedRedisRequirements/>

### Object storage

<SelfManagedObjectStorageRequirements/>

### Additional Requirements
- Access to an internal container registry with the required W&B images
- Access to an internal Helm repository for W&B Helm charts

For complete infrastructure requirements, including networking and load balancer configuration, see the [reference architecture](/platform/hosting/self-managed/ref-arch/#infrastructure-requirements).

<Note>
W&B can be deployed on air-gapped OpenShift Kubernetes clusters. See the [reference architecture](/platform/hosting/self-managed/ref-arch/#kubernetes) for details, and review the [OpenShift section](/platform/hosting/operator/#openshift-kubernetes-clusters) of the Operator guide for specific configuration instructions that you can adapt for your air-gapped OpenShift deployment.
</Note>

## Step 2: Prepare internal container registry

For a successful air-gapped deployment, the following container images must be available in your air-gapped container registry.

You are responsible for tracking the W&B Operator's requirements and maintaining your container registry with updated images regularly. For the most current list of required container images and versions, refer to the Helm chart, or contact [support](mailto:support@wandb.com) or your AISE.

### Core W&B component containers
* [`docker.io/wandb/controller`](https://hub.docker.com/r/wandb/controller)
* [`docker.io/wandb/local`](https://hub.docker.com/r/wandb/local)
* [`docker.io/wandb/console`](https://hub.docker.com/r/wandb/console)
* [`docker.io/wandb/megabinary`](https://hub.docker.com/r/wandb/megabinary)

### Dependencies

* [`docker.io/bitnamilegacy/redis`](https://hub.docker.com/r/bitnamilegacy/redis): Required for local Redis deployment during testing and development. To use the local Redis deployment, ensure that this image is available in your container registry. For production Redis requirements, see the [Redis section](#redis) in Prerequisites.
* [`docker.io/otel/opentelemetry-collector-contrib`](https://hub.docker.com/r/otel/opentelemetry-collector-contrib): W&B depends on the OpenTelemetry agent to collect metrics and logs from resources at the Kubernetes layer for display in W&B.
* [`quay.io/prometheus/prometheus`](https://quay.io/repository/prometheus/prometheus): W&B depends on Prometheus to capture metrics from various components for display in W&B.
* [`quay.io/prometheus-operator/prometheus-config-reloader`](https://quay.io/repository/prometheus-operator/prometheus-config-reloader): A required dependency of Prometheus.


### Get required images

To extract the complete list of required images and versions from the Helm chart values:

1. Download the W&B Operator and Platform Helm charts from the [W&B Helm charts repository](https://github.com/wandb/helm-charts).

2. Inspect the `values.yaml` files to identify all container images and their versions:

    ```bash
    # Extract image references from the Helm chart
    helm show values wandb/operator \
      | awk -F': *' '/^[[:space:]]*repository:/{print $2}' \
      | grep -E '^wandb/' \
      | sort -u
    ```

    The list might look similar to the following. Image versions may vary.

    ```text
    wandb/anaconda2
    wandb/console
    wandb/frontend-nginx
    wandb/local
    wandb/megabinary
    wandb/weave-python
    wandb/weave-trace
    ```


## Step 3: Prepare internal Helm chart repository

Along with the container images, you also must ensure that the following Helm charts are available in your internal Helm Chart repository. Download them from:

- [W&B Operator](https://github.com/wandb/helm-charts/tree/main/charts/operator)
- [W&B Platform](https://github.com/wandb/helm-charts/tree/main/charts/operator-wandb)


The `operator` chart is used to deploy the W&B Operator, which is also referred to as the Controller Manager. The `platform` chart is used to deploy the W&B Platform using the values configured in the custom resource definition (CRD).

## Step 4: Set up Helm repository

Now, configure the Helm repository to pull the W&B Helm charts from your internal repository. Run the following commands to add and update the Helm repository:

```bash
helm repo add local-repo https://charts.yourdomain.com
helm repo update
```

## Step 5: Install the Kubernetes operator

The W&B Kubernetes operator, also known as the controller manager, is responsible for managing the W&B platform components. To install it in an air-gapped environment, 
you must configure it to use your internal container registry.

To do so, you must override the default image settings to use your internal container registry and set the key `airgapped: true` to indicate the expected deployment type. Update the `values.yaml` file as shown below:

```yaml
image:
  repository: registry.yourdomain.com/library/controller
  tag: 1.13.3
airgapped: true
```

Replace the tag with the version that is available in your internal registry.

Install the operator and the CRD:
```bash
helm upgrade --install operator local-repo/operator -n wandb --create-namespace -f values.yaml
```

For full details about the supported values, refer to the [Kubernetes operator GitHub repository](https://github.com/wandb/helm-charts/blob/main/charts/operator/values.yaml).

## Step 6: Set up MySQL database

Before configuring the W&B Custom Resource, you must set up an external MySQL database. For production deployments, W&B strongly recommends using managed database services. However, if you are running your own MySQL instance, create the database and user:

<SelfManagedMysqlDatabaseCreation/>

For MySQL configuration parameters, see the [reference architecture MySQL configuration section](/platform/hosting/self-managed/ref-arch/#mysql-configuration-parameters).

## Step 7: Configure W&B Custom Resource 

After installing the W&B Kubernetes operator, you must configure the Custom Resource (CR) to point to your internal Helm repository and container registry.

This configuration ensures that the Kubernetes operators uses your internal registry and repository are when it deploys the required components of the W&B platform. 

Copy this example CR to a new file named `wandb.yaml`.

```yaml
apiVersion: apps.wandb.com/v1
kind: WeightsAndBiases
metadata:
  labels:
    app.kubernetes.io/instance: wandb
    app.kubernetes.io/name: weightsandbiases
  name: wandb
  namespace: default

spec:
  chart:
    url: http://charts.yourdomain.com
    name: operator-wandb
    version: 0.18.0

  values:
    global:
      host: https://wandb.yourdomain.com
      license: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
      bucket:
        accessKey: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        secretKey: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        name: s3.yourdomain.com:port #Ex.: s3.yourdomain.com:9000
        path: bucket_name
        provider: s3
        region: us-east-1
      mysql:
        database: wandb
        host: mysql.home.lab
        password: password
        port: 3306
        user: wandb
      redis:
        host: redis.yourdomain.com
        port: 6379
        password: password
      api:
        enabled: true
      glue:
        enabled: true
      executor:
        enabled: true
      extraEnv:
        ENABLE_REGISTRY_UI: 'true'

    app:
      image:
        repository: registry.yourdomain.com/local
        tag: 0.59.2

    console:
      image:
        repository: registry.yourdomain.com/console
        tag: 2.12.2

    api:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    executor:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    glue:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    parquet:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    weave:
      image:
        repository: registry.yourdomain.com/weave-python
        tag: 0.59.2

    otel:
      image:
        repository: registry.yourdomain.com/otel/opentelemetry-collector-contrib
        tag: 0.97.0

    prometheus:
      server:
        image:
          repository: registry.yourdomain.com/prometheus/prometheus
          tag: v2.47.0
      configmapReload:
        prometheus:
          image:
            repository: registry.yourdomain.com/prometheus-operator/prometheus-config-reloader
            tag: v0.67.0

    ingress:
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: 0
      class: nginx

    
```

To deploy the W&B platform, the Kubernetes Operator uses the values from your CR to configure the `operator-wandb` Helm chart from your internal repository.

Replace all tags and versions with the versions available in your internal registry. The example above shows the most commonly used components. Depending on your deployment needs, you may also need to configure image repositories for additional components such as `settingsMigrationJob`, `weave-trace`, `filestream`, and others. Refer to the [W&B Helm repository values file](https://github.com/wandb/helm-charts/blob/main/charts/operator-wandb/values.yaml) for the complete list of configurable components.


## Step 8: Deploy the W&B platform

Now that the Kubernetes operator and the CR are configured, apply the `wandb.yaml` configuration to deploy the W&B platform:

```bash
kubectl apply -f wandb.yaml
```

## Step 9: Verify your installation

<SelfManagedVerifyInstallation/>

## FAQ

Refer to the below frequently asked questions (FAQs) and troubleshooting tips during the deployment process:

### There is another ingress class. Can that class be used?
Yes, you can configure your ingress class by modifying the ingress settings in `values.yaml`.

### The certificate bundle has more than one certificate. Would that work?
You must split the certificates into multiple entries in the `customCACerts` section of `values.yaml`.

### How do you prevent the Kubernetes operator from applying unattended updates. Is that possible?
You can turn off auto-updates from the W&B console. Reach out to your W&B team for any questions on the supported versions. W&B supports a major W&B Server release for 12 months from its initial release date. Customers with **Self-Managed** instances are responsible for upgrading in time to maintain support. Avoid staying on an unsupported version. Refer to [Release policies and processes](/release-notes/release-policies).

<Note>
W&B strongly recommends customers with **Self-Managed** instances to update their deployments with the latest release at minimum once per quarter to maintain support and receive the latest features, performance improvements, and fixes.
</Note>

### Does the deployment work if the environment has no connection to public repositories?
If your configuration sets `airgapped` to `true`, the Kubernetes operator uses only your internal resources and does not attempt to connect to public repositories. 
