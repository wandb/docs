From 589d391e9f5bb04dc63b5600b7ad1a12612718de Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Mon, 8 Sep 2025 22:20:51 +0000
Subject: [PATCH] Fix preview workflow issues

- Fix added files not being linked by checking out PR branch before Hugo build
- Fix include file path construction when searching for dependent pages
- Add special handling for index files in path mapping
- Prevent deleted files from having preview links
- Pass isDeleted flag to buildRows function to control link generation
---
 .../workflows/pr-preview-links-on-comment.yml | 23 ++++++++++++++-----
 .github/workflows/pr-preview-links.yml        | 23 ++++++++++++++-----
 2 files changed, 34 insertions(+), 12 deletions(-)

diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
index 69c70f6f..f49cbc8e 100644
--- a/.github/workflows/pr-preview-links-on-comment.yml
+++ b/.github/workflows/pr-preview-links-on-comment.yml
@@ -84,6 +84,9 @@ jobs:
       - name: Build Hugo (generate pageurls)
         if: steps.changed.outputs.any_changed == 'true'
         run: |
+          # Checkout the PR branch to get all changes including new files
+          git checkout ${{ steps.pr.outputs.head_sha }}
+          
           hugo --minify
           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
 
@@ -267,6 +270,9 @@ jobs:
                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                // Special handling for index files
+                path.posix.join('content', lang, '_index.md'),
+                path.posix.join('content', lang, 'index.md'),
               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
               
               // Debug log for new pages
@@ -325,8 +331,12 @@ jobs:
               for (const page of pageMap) {
                 if (page.path && page.path.endsWith('.md')) {
                   try {
-                    // Construct the correct file path: content/<lang>/<page.path>
-                    const contentPath = path.join('content', page.lang || 'en', page.path);
+                    // Construct the correct file path
+                    // page.path might already include content/ prefix, so handle both cases
+                    let contentPath = page.path;
+                    if (!contentPath.startsWith('content/')) {
+                      contentPath = path.join('content', page.lang || 'en', page.path);
+                    }
                     if (fs.existsSync(contentPath)) {
                       const content = fs.readFileSync(contentPath, 'utf8');
                       
@@ -357,7 +367,7 @@ jobs:
               return pagesUsingInclude;
             }
 
-            function buildRows(files) {
+            function buildRows(files, isDeleted = false) {
               const rows = [];
               
               for (const fp of files) {
@@ -388,7 +398,8 @@ jobs:
                   } else {
                     // Regular content file
                     const e = mapEntry(fp);
-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
+                    // Don't create links for deleted files
+                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
                     const pathCell = '`' + e.path + '`';
                     rows.push(`| ${titleCell} | ${pathCell} |`);
                   }
@@ -397,7 +408,7 @@ jobs:
                   // Only link common web assets; skip JSON, map files, etc.
                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
+                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
                   const title = titleFromPath(fp);
                   const titleCell = href ? `[${title}](${href})` : title;
                   const pathCell = '`' + fp + '`';
@@ -438,7 +449,7 @@ jobs:
 
             const addedRows = buildRows(addedFiltered);
             const modifiedRows = buildRows(modified);
-            const deletedRows = buildRows(deletedFiltered);
+            const deletedRows = buildRows(deletedFiltered, true); // Pass true for deleted files
             const renamedRows = buildRenamedRows(renamedFiles);
 
             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + previewBase + ' -->\n**PR Preview: Changed content**\n\nBase preview: ' + previewBase;
diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
index 3ec72cb9..1a08c2cb 100644
--- a/.github/workflows/pr-preview-links.yml
+++ b/.github/workflows/pr-preview-links.yml
@@ -67,6 +67,9 @@ jobs:
           echo "HEAD commit: $(git rev-parse HEAD)"
           echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
           
+          # First, checkout the PR branch to get all changes including new files
+          git checkout ${{ github.event.pull_request.head.sha }}
+          
           hugo --minify
           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
           
@@ -339,6 +342,9 @@ jobs:
                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                // Special handling for index files
+                path.posix.join('content', lang, '_index.md'),
+                path.posix.join('content', lang, 'index.md'),
               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
               
               // Debug log for new pages
@@ -438,8 +444,12 @@ jobs:
               for (const page of pageMap) {
                 if (page.path && page.path.endsWith('.md')) {
                   try {
-                    // Construct the correct file path: content/<lang>/<page.path>
-                    const contentPath = path.join('content', page.lang || 'en', page.path);
+                    // Construct the correct file path
+                    // page.path might already include content/ prefix, so handle both cases
+                    let contentPath = page.path;
+                    if (!contentPath.startsWith('content/')) {
+                      contentPath = path.join('content', page.lang || 'en', page.path);
+                    }
                     if (fs.existsSync(contentPath)) {
                       const content = fs.readFileSync(contentPath, 'utf8');
                       
@@ -470,7 +480,7 @@ jobs:
               return pagesUsingInclude;
             }
 
-            function buildRows(files) {
+            function buildRows(files, isDeleted = false) {
               const rows = [];
               
               for (const fp of files) {
@@ -501,7 +511,8 @@ jobs:
                   } else {
                     // Regular content file
                     const e = mapEntry(fp);
-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
+                    // Don't create links for deleted files
+                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
                     const pathCell = '`' + e.path + '`';
                     rows.push(`| ${titleCell} | ${pathCell} |`);
                   }
@@ -510,7 +521,7 @@ jobs:
                   // Only link common web assets; skip JSON, map files, etc.
                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
+                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
                   const title = titleFromPath(fp);
                   const titleCell = href ? `[${title}](${href})` : title;
                   const pathCell = '`' + fp + '`';
@@ -605,7 +616,7 @@ jobs:
 
             const addedRows = buildRows(addedInfo.files);
             const modifiedRows = buildRows(modifiedInfo.files);
-            const deletedRows = buildRows(deletedInfo.files);
+            const deletedRows = buildRows(deletedInfo.files, true); // Pass true for deleted files
             const renamedRows = buildRenamedRows(renamedInfo.files);
 
             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + (previewBase || '') + ' -->\n**PR Preview: Changed content**' + (previewBase ? `\n\nBase preview: ${previewBase}` : '\n\n‚è≥ *Links will be added automatically when Cloudflare Pages finishes deploying (typically 2-5 minutes)*');
-- 
2.48.1