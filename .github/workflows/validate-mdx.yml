name: Validate MDX
on:
  pull_request:
    # Remove path filter to ensure the workflow always runs,
    # but we'll check for MDX changes within the job

jobs:
  validate-mdx:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare with base branch
      
      - name: Check for MDX changes
        id: mdx-check
        run: |
          # Get the list of changed files between the base and head branches
          echo "Checking for MDX file changes..."
          MDX_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.mdx' | head -1)
          
          if [ -n "$MDX_CHANGED" ]; then
            echo "MDX files were modified"
            echo "mdx_changed=true" >> $GITHUB_OUTPUT
            echo "Changed MDX files:"
            git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.mdx'
          else
            echo "No MDX files were modified - skipping validation"
            echo "mdx_changed=false" >> $GITHUB_OUTPUT
          fi
      
      - uses: actions/setup-node@v4
        if: steps.mdx-check.outputs.mdx_changed == 'true'
        with:
          node-version: '20'
      
      - name: Cache Mintlify CLI
        if: steps.mdx-check.outputs.mdx_changed == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-mintlify-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-mintlify-
      
      - name: Install Mintlify CLI
        if: steps.mdx-check.outputs.mdx_changed == 'true'
        run: npm install -g mintlify
      
      - name: Validate MDX with Mintlify
        if: steps.mdx-check.outputs.mdx_changed == 'true'
        run: |
          # Use optimized validation for changed files (faster)
          # Falls back to full validation if > 20 files changed
          ./scripts/mdx-validation/validate-changed-mdx.sh
      
      - name: Check for broken links
        if: steps.mdx-check.outputs.mdx_changed == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— CHECKING FOR BROKEN LINKS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Run mint broken-links command
          if mint broken-links; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… NO BROKEN LINKS FOUND"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          else
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ BROKEN LINKS DETECTED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Please fix the broken links reported above"
            exit 1
          fi
