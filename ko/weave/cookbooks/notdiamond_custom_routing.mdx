---
title: "NotDiamond 커스텀 라우팅"
description: "W&B Weave에서 NotDiamond 커스텀 라우팅을 사용하는 방법을 알아보세요"
---

<Note>
이 노트북은 대화형 노트북입니다. 로컬에서 실행하거나 아래 링크를 통해 사용할 수 있습니다:
- [Google Colab에서 열기](https://colab.research.google.com/github/wandb/docs/blob/main/weave/cookbooks/source/notdiamond_custom_routing.ipynb)
- [GitHub에서 소스 보기](https://github.com/wandb/docs/blob/main/weave/cookbooks/source/notdiamond_custom_routing.ipynb)
</Note>

<div id="custom-routing-for-llm-prompts-with-not-diamond">
  # Not Diamond를 사용한 LLM 프롬프트 커스텀 라우팅
</div>

이 노트북에서는 Weave와 [Not Diamond의 커스텀 라우팅](https://docs.notdiamond.ai/docs/router-training-quickstart)을 함께 사용하여 Evaluation 결과를 기반으로 LLM 프롬프트를 가장 적절한 모델로 라우팅하는 방법을 보여줍니다.

<div id="routing-prompts">
  ## 프롬프트 라우팅
</div>

복잡한 LLM 워크플로를 구축할 때는 정확도, 비용, 호출 지연(latency)에 따라 서로 다른 모델에 프롬프트를 보내야 할 수 있습니다.
사용자는 [Not Diamond](https://www.notdiamond.ai/)를 사용해 이러한 워크플로에서 프롬프트를 자신의 요구에 가장 적합한 모델로 라우팅하여, 정확도를 최대화하는 동시에 모델 비용을 절감할 수 있습니다.

어떤 데이터 분포에서도 단일 모델 하나가 모든 쿼리에서 다른 모든 모델보다 항상 더 잘 동작하는 경우는 거의 없습니다. 여러 모델을 결합해, 어떤 상황에서 어떤 LLM을 호출할지 학습하는 "메타 모델(meta-model)"을 구성하면, 개별 모델 각각의 성능을 능가할 수 있을 뿐만 아니라 비용과 지연 시간도 함께 줄일 수 있습니다.

<div id="custom-routing">
  ## 커스텀 라우팅
</div>

프롬프트용 커스텀 라우터를 학습하려면 다음 세 가지가 필요합니다:

1. LLM 프롬프트 세트: 프롬프트는 문자열이어야 하며, 애플리케이션에서 실제로 사용하는 프롬프트를 잘 대표해야 합니다.
1. LLM 응답: 각 입력에 대해 후보 LLM이 생성한 응답입니다. 후보 LLM에는 지원되는 LLM과 사용자의 커스텀 모델 모두를 포함할 수 있습니다.
1. 후보 LLM이 각 입력에 대해 생성한 응답에 대한 평가 점수: 점수는 숫자이며, 필요한 어떤 지표든 사용할 수 있습니다.

이 데이터를 Not Diamond API에 제출하면 각 워크플로에 맞게 튜닝된 커스텀 라우터를 학습할 수 있습니다.

<div id="setting-up-the-training-data">
  ## 학습 데이터 설정하기
</div>

실무에서는 직접 만든 Evaluation을 사용해 커스텀 라우터를 학습하게 됩니다. 하지만 이 예제 노트북에서는 LLM 응답을 사용하여
[HumanEval 데이터셋](https://github.com/openai/human-eval)에 대한 코딩 작업용 커스텀 라우터를 학습합니다.

먼저 이 예제를 위해 준비해 둔 데이터셋을 다운로드한 다음, 각 모델별 LLM 응답을 EvaluationResults로 파싱합니다.

```python lines
!curl -L "https://drive.google.com/uc?export=download&id=1q1zNZHioy9B7M-WRjsJPkfvFosfaHX38" -o humaneval.csv
python
import random

import weave
from weave.flow.dataset import Dataset
from weave.flow.eval import EvaluationResults
from weave.integrations.notdiamond.util import get_model_evals

pct_train = 0.8
pct_test = 1 - pct_train

# 실제로는 데이터셋에 Evaluation을 빌드하고
# `evaluation.get_eval_results(model)`을 호출합니다.
model_evals = get_model_evals("./humaneval.csv")
model_train = {}
model_test = {}
for model, evaluation_results in model_evals.items():
    n_results = len(evaluation_results.rows)
    all_idxs = list(range(n_results))
    train_idxs = random.sample(all_idxs, k=int(n_results * pct_train))
    test_idxs = [idx for idx in all_idxs if idx not in train_idxs]

    model_train[model] = EvaluationResults(
        rows=weave.Table([evaluation_results.rows[idx] for idx in train_idxs])
    )
    model_test[model] = Dataset(
        rows=weave.Table([evaluation_results.rows[idx] for idx in test_idxs])
    )
    print(
        f"Found {len(train_idxs)} train rows and {len(test_idxs)} test rows for {model}."
    )
```


<div id="training-a-custom-router">
  ## 커스텀 라우터 학습하기
</div>

이제 EvaluationResults가 있으므로 커스텀 라우터를 학습시킬 수 있습니다. 먼저 [계정을 생성](https://app.notdiamond.ai/keys)하고
[API 키를 발급](https://app.notdiamond.ai/keys)한 다음, 아래에 해당 API 키를 입력하세요.

<Frame>
  ![Create an API key](/weave/guides/integrations/imgs/notdiamond/api-keys.png)
</Frame>

```python lines
import os

from weave.integrations.notdiamond.custom_router import train_router

api_key = os.getenv("NOTDIAMOND_API_KEY", "<YOUR_API_KEY>")

preference_id = train_router(
    model_evals=model_train,
    prompt_column="prompt",
    response_column="actual",
    language="en",
    maximize=True,
    api_key=api_key,
    # 첫 번째 커스텀 라우터를 학습하려면 이 줄을 주석 처리된 상태로 두세요
    # 커스텀 라우터를 재학습하려면 아래 주석을 해제하세요
    # preference_id=preference_id,
)
```

그런 다음 Not Diamond 앱을 통해 커스텀 라우터의 훈련 진행 상황을 확인할 수 있습니다.

<Frame>
  ![라우터 학습 진행 상황 확인](/weave/guides/integrations/imgs/notdiamond/router-preferences.png)
</Frame>

커스텀 라우터의 훈련이 완료되면, 이를 사용해 프롬프트를 라우팅할 수 있습니다.

```python lines
from notdiamond import NotDiamond

import weave

weave.init("notdiamond-quickstart")

llm_configs = [
    "anthropic/claude-3-5-sonnet-20240620",
    "openai/gpt-4o-2024-05-13",
    "google/gemini-1.5-pro-latest",
    "openai/gpt-4-turbo-2024-04-09",
    "anthropic/claude-3-opus-20240229",
]
client = NotDiamond(api_key=api_key, llm_configs=llm_configs)

new_prompt = (
    """
You are a helpful coding assistant. Using the provided function signature, write the implementation for the function
in Python. Write only the function. Do not include any other text.

from typing import List

def has_close_elements(numbers: List[float], threshold: float) -> bool:
    """
    """ Check if in given list of numbers, are any two numbers closer to each other than
    given threshold.
    >>> has_close_elements([1.0, 2.0, 3.0], 0.5)
    False
    >>> has_close_elements([1.0, 2.8, 3.0, 4.0, 5.0, 2.0], 0.3)
    True
    """
    """
"""
)
session_id, routing_target_model = client.model_select(
    messages=[{"role": "user", "content": new_prompt}],
    preference_id=preference_id,
)

print(f"Session ID: {session_id}")
print(f"Target Model: {routing_target_model}")
```

이 예제에서는 Not Diamond가 Weave 자동 트레이싱과 호환된다는 점도 활용했습니다. 결과는 Weave UI에서 확인할 수 있습니다.

![커스텀 라우팅을 위한 Weave UI](/weave/guides/integrations/imgs/notdiamond/weave-trace.png)


<div id="evaluating-your-custom-router">
  ## 커스텀 라우터 평가하기
</div>

커스텀 라우터를 학습한 후에는 다음 중 하나의 방식으로 성능을 평가할 수 있습니다.

* 학습에 사용한 프롬프트를 제출하여 in-sample 성능을 평가하거나
* 새 프롬프트나 홀드아웃 프롬프트를 제출하여 out-of-sample 성능을 평가할 수 있습니다.

아래 예시에서는 커스텀 라우터의 성능을 평가하기 위해 테스트 세트를 제출합니다.

```python lines
from weave.integrations.notdiamond.custom_router import evaluate_router

eval_prompt_column = "prompt"
eval_response_column = "actual"

best_provider_model, nd_model = evaluate_router(
    model_datasets=model_test,
    prompt_column=eval_prompt_column,
    response_column=eval_response_column,
    api_key=api_key,
    preference_id=preference_id,
)
python
@weave.op()
def is_correct(score: int, output: dict) -> dict:
    # 이미 모델 응답이 있으므로 score를 편의상 조작합니다
    return {"correct": score}

best_provider_eval = weave.Evaluation(
    dataset=best_provider_model.model_results.to_dict(orient="records"),
    scorers=[is_correct],
)
await best_provider_eval.evaluate(best_provider_model)

nd_eval = weave.Evaluation(
    dataset=nd_model.model_results.to_dict(orient="records"), scorers=[is_correct]
)
await nd_eval.evaluate(nd_model)
```

이 예에서는 Not Diamond &quot;메타 모델(meta-model)&quot;이 여러 다른 모델로 프롬프트를 라우팅합니다.

Weave를 통해 커스텀 라우터를 학습할 때 Weave는 Evaluation을 실행하고 결과를 Weave UI에 업로드합니다. 커스텀 라우터 프로세스가 완료되면 Weave UI에서 결과를 검토할 수 있습니다.

UI에서 Not Diamond &quot;메타 모델(meta-model)&quot;이 프롬프트에 더 정확하게 답변할 가능성이 높은 다른 모델로 프롬프트를 라우팅함으로써 가장 성능이 좋은 단일 모델보다 더 뛰어난 성능을 낸다는 것을 확인할 수 있습니다.

<Frame>
  ![Evaluating Not Diamond](/weave/guides/integrations/imgs/notdiamond/evaluations.png)
</Frame>
