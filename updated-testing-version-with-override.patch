From 589d391e9f5bb04dc63b5600b7ad1a12612718de Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Mon, 8 Sep 2025 22:20:51 +0000
Subject: [PATCH 1/5] Fix preview workflow issues

- Fix added files not being linked by checking out PR branch before Hugo build
- Fix include file path construction when searching for dependent pages
- Add special handling for index files in path mapping
- Prevent deleted files from having preview links
- Pass isDeleted flag to buildRows function to control link generation
---
 .../workflows/pr-preview-links-on-comment.yml | 23 ++++++++++++++-----
 .github/workflows/pr-preview-links.yml        | 23 ++++++++++++++-----
 2 files changed, 34 insertions(+), 12 deletions(-)

diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
index 69c70f6f..f49cbc8e 100644
--- a/.github/workflows/pr-preview-links-on-comment.yml
+++ b/.github/workflows/pr-preview-links-on-comment.yml
@@ -84,6 +84,9 @@ jobs:
       - name: Build Hugo (generate pageurls)
         if: steps.changed.outputs.any_changed == 'true'
         run: |
+          # Checkout the PR branch to get all changes including new files
+          git checkout ${{ steps.pr.outputs.head_sha }}
+          
           hugo --minify
           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
 
@@ -267,6 +270,9 @@ jobs:
                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                // Special handling for index files
+                path.posix.join('content', lang, '_index.md'),
+                path.posix.join('content', lang, 'index.md'),
               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
               
               // Debug log for new pages
@@ -325,8 +331,12 @@ jobs:
               for (const page of pageMap) {
                 if (page.path && page.path.endsWith('.md')) {
                   try {
-                    // Construct the correct file path: content/<lang>/<page.path>
-                    const contentPath = path.join('content', page.lang || 'en', page.path);
+                    // Construct the correct file path
+                    // page.path might already include content/ prefix, so handle both cases
+                    let contentPath = page.path;
+                    if (!contentPath.startsWith('content/')) {
+                      contentPath = path.join('content', page.lang || 'en', page.path);
+                    }
                     if (fs.existsSync(contentPath)) {
                       const content = fs.readFileSync(contentPath, 'utf8');
                       
@@ -357,7 +367,7 @@ jobs:
               return pagesUsingInclude;
             }
 
-            function buildRows(files) {
+            function buildRows(files, isDeleted = false) {
               const rows = [];
               
               for (const fp of files) {
@@ -388,7 +398,8 @@ jobs:
                   } else {
                     // Regular content file
                     const e = mapEntry(fp);
-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
+                    // Don't create links for deleted files
+                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
                     const pathCell = '`' + e.path + '`';
                     rows.push(`| ${titleCell} | ${pathCell} |`);
                   }
@@ -397,7 +408,7 @@ jobs:
                   // Only link common web assets; skip JSON, map files, etc.
                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
+                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
                   const title = titleFromPath(fp);
                   const titleCell = href ? `[${title}](${href})` : title;
                   const pathCell = '`' + fp + '`';
@@ -438,7 +449,7 @@ jobs:
 
             const addedRows = buildRows(addedFiltered);
             const modifiedRows = buildRows(modified);
-            const deletedRows = buildRows(deletedFiltered);
+            const deletedRows = buildRows(deletedFiltered, true); // Pass true for deleted files
             const renamedRows = buildRenamedRows(renamedFiles);
 
             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + previewBase + ' -->\n**PR Preview: Changed content**\n\nBase preview: ' + previewBase;
diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
index 3ec72cb9..1a08c2cb 100644
--- a/.github/workflows/pr-preview-links.yml
+++ b/.github/workflows/pr-preview-links.yml
@@ -67,6 +67,9 @@ jobs:
           echo "HEAD commit: $(git rev-parse HEAD)"
           echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
           
+          # First, checkout the PR branch to get all changes including new files
+          git checkout ${{ github.event.pull_request.head.sha }}
+          
           hugo --minify
           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
           
@@ -339,6 +342,9 @@ jobs:
                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                // Special handling for index files
+                path.posix.join('content', lang, '_index.md'),
+                path.posix.join('content', lang, 'index.md'),
               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
               
               // Debug log for new pages
@@ -438,8 +444,12 @@ jobs:
               for (const page of pageMap) {
                 if (page.path && page.path.endsWith('.md')) {
                   try {
-                    // Construct the correct file path: content/<lang>/<page.path>
-                    const contentPath = path.join('content', page.lang || 'en', page.path);
+                    // Construct the correct file path
+                    // page.path might already include content/ prefix, so handle both cases
+                    let contentPath = page.path;
+                    if (!contentPath.startsWith('content/')) {
+                      contentPath = path.join('content', page.lang || 'en', page.path);
+                    }
                     if (fs.existsSync(contentPath)) {
                       const content = fs.readFileSync(contentPath, 'utf8');
                       
@@ -470,7 +480,7 @@ jobs:
               return pagesUsingInclude;
             }
 
-            function buildRows(files) {
+            function buildRows(files, isDeleted = false) {
               const rows = [];
               
               for (const fp of files) {
@@ -501,7 +511,8 @@ jobs:
                   } else {
                     // Regular content file
                     const e = mapEntry(fp);
-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
+                    // Don't create links for deleted files
+                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
                     const pathCell = '`' + e.path + '`';
                     rows.push(`| ${titleCell} | ${pathCell} |`);
                   }
@@ -510,7 +521,7 @@ jobs:
                   // Only link common web assets; skip JSON, map files, etc.
                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
+                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
                   const title = titleFromPath(fp);
                   const titleCell = href ? `[${title}](${href})` : title;
                   const pathCell = '`' + fp + '`';
@@ -605,7 +616,7 @@ jobs:
 
             const addedRows = buildRows(addedInfo.files);
             const modifiedRows = buildRows(modifiedInfo.files);
-            const deletedRows = buildRows(deletedInfo.files);
+            const deletedRows = buildRows(deletedInfo.files, true); // Pass true for deleted files
             const renamedRows = buildRenamedRows(renamedInfo.files);
 
             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + (previewBase || '') + ' -->\n**PR Preview: Changed content**' + (previewBase ? `\n\nBase preview: ${previewBase}` : '\n\n⏳ *Links will be added automatically when Cloudflare Pages finishes deploying (typically 2-5 minutes)*');
-- 
2.48.1


From 7544883b5cc20c641e7fed1ee11ff576a34cc0af Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Mon, 8 Sep 2025 23:30:30 +0000
Subject: [PATCH 2/5] Checkpoint before follow-up message

Co-authored-by: matt.linville <matt.linville@wandb.com>
---
 production-version-clean.patch | 169 +++++++++++++++++++++++++++++++++
 1 file changed, 169 insertions(+)
 create mode 100644 production-version-clean.patch

diff --git a/production-version-clean.patch b/production-version-clean.patch
new file mode 100644
index 00000000..000eb3ca
--- /dev/null
+++ b/production-version-clean.patch
@@ -0,0 +1,169 @@
+From 589d391e9f5bb04dc63b5600b7ad1a12612718de Mon Sep 17 00:00:00 2001
+From: Cursor Agent <cursoragent@cursor.com>
+Date: Mon, 8 Sep 2025 22:20:51 +0000
+Subject: [PATCH] Fix preview workflow issues
+
+- Fix added files not being linked by checking out PR branch before Hugo build
+- Fix include file path construction when searching for dependent pages
+- Add special handling for index files in path mapping
+- Prevent deleted files from having preview links
+- Pass isDeleted flag to buildRows function to control link generation
+---
+ .../workflows/pr-preview-links-on-comment.yml | 23 ++++++++++++++-----
+ .github/workflows/pr-preview-links.yml        | 23 ++++++++++++++-----
+ 2 files changed, 34 insertions(+), 12 deletions(-)
+
+diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
+index 69c70f6f..f49cbc8e 100644
+--- a/.github/workflows/pr-preview-links-on-comment.yml
++++ b/.github/workflows/pr-preview-links-on-comment.yml
+@@ -84,6 +84,9 @@ jobs:
+       - name: Build Hugo (generate pageurls)
+         if: steps.changed.outputs.any_changed == 'true'
+         run: |
++          # Checkout the PR branch to get all changes including new files
++          git checkout ${{ steps.pr.outputs.head_sha }}
++          
+           hugo --minify
+           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
+ 
+@@ -267,6 +270,9 @@ jobs:
+                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
+                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
++                // Special handling for index files
++                path.posix.join('content', lang, '_index.md'),
++                path.posix.join('content', lang, 'index.md'),
+               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
+               
+               // Debug log for new pages
+@@ -325,8 +331,12 @@ jobs:
+               for (const page of pageMap) {
+                 if (page.path && page.path.endsWith('.md')) {
+                   try {
+-                    // Construct the correct file path: content/<lang>/<page.path>
+-                    const contentPath = path.join('content', page.lang || 'en', page.path);
++                    // Construct the correct file path
++                    // page.path might already include content/ prefix, so handle both cases
++                    let contentPath = page.path;
++                    if (!contentPath.startsWith('content/')) {
++                      contentPath = path.join('content', page.lang || 'en', page.path);
++                    }
+                     if (fs.existsSync(contentPath)) {
+                       const content = fs.readFileSync(contentPath, 'utf8');
+                       
+@@ -357,7 +367,7 @@ jobs:
+               return pagesUsingInclude;
+             }
+ 
+-            function buildRows(files) {
++            function buildRows(files, isDeleted = false) {
+               const rows = [];
+               
+               for (const fp of files) {
+@@ -388,7 +398,8 @@ jobs:
+                   } else {
+                     // Regular content file
+                     const e = mapEntry(fp);
+-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
++                    // Don't create links for deleted files
++                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
+                     const pathCell = '`' + e.path + '`';
+                     rows.push(`| ${titleCell} | ${pathCell} |`);
+                   }
+@@ -397,7 +408,7 @@ jobs:
+                   // Only link common web assets; skip JSON, map files, etc.
+                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
+                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
+-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
++                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
+                   const title = titleFromPath(fp);
+                   const titleCell = href ? `[${title}](${href})` : title;
+                   const pathCell = '`' + fp + '`';
+@@ -438,7 +449,7 @@ jobs:
+ 
+             const addedRows = buildRows(addedFiltered);
+             const modifiedRows = buildRows(modified);
+-            const deletedRows = buildRows(deletedFiltered);
++            const deletedRows = buildRows(deletedFiltered, true); // Pass true for deleted files
+             const renamedRows = buildRenamedRows(renamedFiles);
+ 
+             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + previewBase + ' -->\n**PR Preview: Changed content**\n\nBase preview: ' + previewBase;
+diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
+index 3ec72cb9..1a08c2cb 100644
+--- a/.github/workflows/pr-preview-links.yml
++++ b/.github/workflows/pr-preview-links.yml
+@@ -67,6 +67,9 @@ jobs:
+           echo "HEAD commit: $(git rev-parse HEAD)"
+           echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
+           
++          # First, checkout the PR branch to get all changes including new files
++          git checkout ${{ github.event.pull_request.head.sha }}
++          
+           hugo --minify
+           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
+           
+@@ -339,6 +342,9 @@ jobs:
+                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
+                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
++                // Special handling for index files
++                path.posix.join('content', lang, '_index.md'),
++                path.posix.join('content', lang, 'index.md'),
+               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
+               
+               // Debug log for new pages
+@@ -438,8 +444,12 @@ jobs:
+               for (const page of pageMap) {
+                 if (page.path && page.path.endsWith('.md')) {
+                   try {
+-                    // Construct the correct file path: content/<lang>/<page.path>
+-                    const contentPath = path.join('content', page.lang || 'en', page.path);
++                    // Construct the correct file path
++                    // page.path might already include content/ prefix, so handle both cases
++                    let contentPath = page.path;
++                    if (!contentPath.startsWith('content/')) {
++                      contentPath = path.join('content', page.lang || 'en', page.path);
++                    }
+                     if (fs.existsSync(contentPath)) {
+                       const content = fs.readFileSync(contentPath, 'utf8');
+                       
+@@ -470,7 +480,7 @@ jobs:
+               return pagesUsingInclude;
+             }
+ 
+-            function buildRows(files) {
++            function buildRows(files, isDeleted = false) {
+               const rows = [];
+               
+               for (const fp of files) {
+@@ -501,7 +511,8 @@ jobs:
+                   } else {
+                     // Regular content file
+                     const e = mapEntry(fp);
+-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
++                    // Don't create links for deleted files
++                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
+                     const pathCell = '`' + e.path + '`';
+                     rows.push(`| ${titleCell} | ${pathCell} |`);
+                   }
+@@ -510,7 +521,7 @@ jobs:
+                   // Only link common web assets; skip JSON, map files, etc.
+                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
+                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
+-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
++                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
+                   const title = titleFromPath(fp);
+                   const titleCell = href ? `[${title}](${href})` : title;
+                   const pathCell = '`' + fp + '`';
+@@ -605,7 +616,7 @@ jobs:
+ 
+             const addedRows = buildRows(addedInfo.files);
+             const modifiedRows = buildRows(modifiedInfo.files);
+-            const deletedRows = buildRows(deletedInfo.files);
++            const deletedRows = buildRows(deletedInfo.files, true); // Pass true for deleted files
+             const renamedRows = buildRenamedRows(renamedInfo.files);
+ 
+             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + (previewBase || '') + ' -->\n**PR Preview: Changed content**' + (previewBase ? `\n\nBase preview: ${previewBase}` : '\n\n⏳ *Links will be added automatically when Cloudflare Pages finishes deploying (typically 2-5 minutes)*');
+-- 
+2.48.1
\ No newline at end of file
-- 
2.48.1


From 5e4a6d27574db3430f9f8d9bf6b60aca334d5280 Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Mon, 8 Sep 2025 23:32:54 +0000
Subject: [PATCH 3/5] Fix preview workflow issues and add testing override

Co-authored-by: matt.linville <matt.linville@wandb.com>
---
 deployment-instructions.md          |  85 +++++++++++
 testing-version-with-override.patch | 223 ++++++++++++++++++++++++++++
 2 files changed, 308 insertions(+)
 create mode 100644 deployment-instructions.md
 create mode 100644 testing-version-with-override.patch

diff --git a/deployment-instructions.md b/deployment-instructions.md
new file mode 100644
index 00000000..26019c46
--- /dev/null
+++ b/deployment-instructions.md
@@ -0,0 +1,85 @@
+# Preview Workflow Fix Deployment Instructions
+
+## Current Situation
+
+I've created fixes for the HTML preview workflow issues and prepared two versions:
+
+### 1. Testing Version (with temporary override)
+- **File**: `testing-version-with-override.patch`
+- **Branch**: `testing-with-override`
+- **Purpose**: For testing in your fork's main branch
+- **Contains**: All fixes + temporary hardcoded Cloudflare preview URL from PR #1607
+
+### 2. Production Version (clean)
+- **File**: `production-version-clean.patch`
+- **Branch**: `fix-preview-workflow-issues`
+- **Purpose**: For the final PR to wandb/docs
+- **Contains**: Only the fixes, no temporary overrides
+
+## Deployment Steps
+
+### Step 1: Test in Your Fork
+
+1. Apply the testing version to your fork's main branch:
+   ```bash
+   # In your local clone of mdlinville/docs
+   git checkout main
+   git apply testing-version-with-override.patch
+   git add .
+   git commit -m "Test preview workflow fixes with temporary override"
+   git push origin main
+   ```
+
+2. Create a test PR in your fork with various file changes:
+   - Add a new file
+   - Modify an existing file (including _index.md)
+   - Delete a file
+   - Modify an include file
+   - Rename/move a file
+
+3. Verify the preview comment shows:
+   - Added files ARE linked
+   - Modified files ARE linked (including index files)
+   - Deleted files are NOT linked
+   - Include files show dependent pages with links
+
+### Step 2: Deploy to Production
+
+Once testing is successful:
+
+1. Apply the clean version to a new branch:
+   ```bash
+   # In your local clone of wandb/docs
+   git checkout main
+   git pull origin main
+   git checkout -b fix-preview-workflow-issues
+   git apply production-version-clean.patch
+   git add .
+   git commit -m "Fix preview workflow issues
+
+   - Fix added files not being linked by checking out PR branch before Hugo build
+   - Fix include file path construction when searching for dependent pages
+   - Add special handling for index files in path mapping
+   - Prevent deleted files from having preview links
+   - Pass isDeleted flag to buildRows function to control link generation"
+   git push origin fix-preview-workflow-issues
+   ```
+
+2. Create a PR from `fix-preview-workflow-issues` to `wandb/docs:main`
+
+## What Was Fixed
+
+1. **Added files not linked**: Now checks out PR branch before Hugo build
+2. **Includes without links**: Fixed path construction for finding dependent pages
+3. **Modified index not linked**: Added special handling for _index.md files
+4. **Deleted files with links**: Added isDeleted flag to prevent link generation
+
+## Testing Override Details
+
+The testing version uses a hardcoded URL: `https://1607.docs-14y.pages.dev`
+
+This override is in two places:
+- `.github/workflows/pr-preview-links.yml` (line ~224)
+- `.github/workflows/pr-preview-links-on-comment.yml` (line ~131)
+
+Look for comments marked "TEMPORARY OVERRIDE FOR TESTING - Remove before production"
\ No newline at end of file
diff --git a/testing-version-with-override.patch b/testing-version-with-override.patch
new file mode 100644
index 00000000..f533eb33
--- /dev/null
+++ b/testing-version-with-override.patch
@@ -0,0 +1,223 @@
+From 589d391e9f5bb04dc63b5600b7ad1a12612718de Mon Sep 17 00:00:00 2001
+From: Cursor Agent <cursoragent@cursor.com>
+Date: Mon, 8 Sep 2025 22:20:51 +0000
+Subject: [PATCH 1/2] Fix preview workflow issues
+
+- Fix added files not being linked by checking out PR branch before Hugo build
+- Fix include file path construction when searching for dependent pages
+- Add special handling for index files in path mapping
+- Prevent deleted files from having preview links
+- Pass isDeleted flag to buildRows function to control link generation
+---
+ .../workflows/pr-preview-links-on-comment.yml | 23 ++++++++++++++-----
+ .github/workflows/pr-preview-links.yml        | 23 ++++++++++++++-----
+ 2 files changed, 34 insertions(+), 12 deletions(-)
+
+diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
+index 69c70f6f..f49cbc8e 100644
+--- a/.github/workflows/pr-preview-links-on-comment.yml
++++ b/.github/workflows/pr-preview-links-on-comment.yml
+@@ -84,6 +84,9 @@ jobs:
+       - name: Build Hugo (generate pageurls)
+         if: steps.changed.outputs.any_changed == 'true'
+         run: |
++          # Checkout the PR branch to get all changes including new files
++          git checkout ${{ steps.pr.outputs.head_sha }}
++          
+           hugo --minify
+           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
+ 
+@@ -267,6 +270,9 @@ jobs:
+                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
+                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
++                // Special handling for index files
++                path.posix.join('content', lang, '_index.md'),
++                path.posix.join('content', lang, 'index.md'),
+               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
+               
+               // Debug log for new pages
+@@ -325,8 +331,12 @@ jobs:
+               for (const page of pageMap) {
+                 if (page.path && page.path.endsWith('.md')) {
+                   try {
+-                    // Construct the correct file path: content/<lang>/<page.path>
+-                    const contentPath = path.join('content', page.lang || 'en', page.path);
++                    // Construct the correct file path
++                    // page.path might already include content/ prefix, so handle both cases
++                    let contentPath = page.path;
++                    if (!contentPath.startsWith('content/')) {
++                      contentPath = path.join('content', page.lang || 'en', page.path);
++                    }
+                     if (fs.existsSync(contentPath)) {
+                       const content = fs.readFileSync(contentPath, 'utf8');
+                       
+@@ -357,7 +367,7 @@ jobs:
+               return pagesUsingInclude;
+             }
+ 
+-            function buildRows(files) {
++            function buildRows(files, isDeleted = false) {
+               const rows = [];
+               
+               for (const fp of files) {
+@@ -388,7 +398,8 @@ jobs:
+                   } else {
+                     // Regular content file
+                     const e = mapEntry(fp);
+-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
++                    // Don't create links for deleted files
++                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
+                     const pathCell = '`' + e.path + '`';
+                     rows.push(`| ${titleCell} | ${pathCell} |`);
+                   }
+@@ -397,7 +408,7 @@ jobs:
+                   // Only link common web assets; skip JSON, map files, etc.
+                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
+                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
+-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
++                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
+                   const title = titleFromPath(fp);
+                   const titleCell = href ? `[${title}](${href})` : title;
+                   const pathCell = '`' + fp + '`';
+@@ -438,7 +449,7 @@ jobs:
+ 
+             const addedRows = buildRows(addedFiltered);
+             const modifiedRows = buildRows(modified);
+-            const deletedRows = buildRows(deletedFiltered);
++            const deletedRows = buildRows(deletedFiltered, true); // Pass true for deleted files
+             const renamedRows = buildRenamedRows(renamedFiles);
+ 
+             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + previewBase + ' -->\n**PR Preview: Changed content**\n\nBase preview: ' + previewBase;
+diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
+index 3ec72cb9..1a08c2cb 100644
+--- a/.github/workflows/pr-preview-links.yml
++++ b/.github/workflows/pr-preview-links.yml
+@@ -67,6 +67,9 @@ jobs:
+           echo "HEAD commit: $(git rev-parse HEAD)"
+           echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
+           
++          # First, checkout the PR branch to get all changes including new files
++          git checkout ${{ github.event.pull_request.head.sha }}
++          
+           hugo --minify
+           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
+           
+@@ -339,6 +342,9 @@ jobs:
+                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
+                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
++                // Special handling for index files
++                path.posix.join('content', lang, '_index.md'),
++                path.posix.join('content', lang, 'index.md'),
+               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
+               
+               // Debug log for new pages
+@@ -438,8 +444,12 @@ jobs:
+               for (const page of pageMap) {
+                 if (page.path && page.path.endsWith('.md')) {
+                   try {
+-                    // Construct the correct file path: content/<lang>/<page.path>
+-                    const contentPath = path.join('content', page.lang || 'en', page.path);
++                    // Construct the correct file path
++                    // page.path might already include content/ prefix, so handle both cases
++                    let contentPath = page.path;
++                    if (!contentPath.startsWith('content/')) {
++                      contentPath = path.join('content', page.lang || 'en', page.path);
++                    }
+                     if (fs.existsSync(contentPath)) {
+                       const content = fs.readFileSync(contentPath, 'utf8');
+                       
+@@ -470,7 +480,7 @@ jobs:
+               return pagesUsingInclude;
+             }
+ 
+-            function buildRows(files) {
++            function buildRows(files, isDeleted = false) {
+               const rows = [];
+               
+               for (const fp of files) {
+@@ -501,7 +511,8 @@ jobs:
+                   } else {
+                     // Regular content file
+                     const e = mapEntry(fp);
+-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
++                    // Don't create links for deleted files
++                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
+                     const pathCell = '`' + e.path + '`';
+                     rows.push(`| ${titleCell} | ${pathCell} |`);
+                   }
+@@ -510,7 +521,7 @@ jobs:
+                   // Only link common web assets; skip JSON, map files, etc.
+                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
+                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
+-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
++                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
+                   const title = titleFromPath(fp);
+                   const titleCell = href ? `[${title}](${href})` : title;
+                   const pathCell = '`' + fp + '`';
+@@ -605,7 +616,7 @@ jobs:
+ 
+             const addedRows = buildRows(addedInfo.files);
+             const modifiedRows = buildRows(modifiedInfo.files);
+-            const deletedRows = buildRows(deletedInfo.files);
++            const deletedRows = buildRows(deletedInfo.files, true); // Pass true for deleted files
+             const renamedRows = buildRenamedRows(renamedInfo.files);
+ 
+             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + (previewBase || '') + ' -->\n**PR Preview: Changed content**' + (previewBase ? `\n\nBase preview: ${previewBase}` : '\n\n⏳ *Links will be added automatically when Cloudflare Pages finishes deploying (typically 2-5 minutes)*');
+-- 
+2.48.1
+
+
+From 7a3c2bb99bf644cc467f165f4d66732f12747b70 Mon Sep 17 00:00:00 2001
+From: Cursor Agent <cursoragent@cursor.com>
+Date: Mon, 8 Sep 2025 23:17:19 +0000
+Subject: [PATCH 2/2] Add temporary testing override for Cloudflare preview URL
+
+TEMPORARY: Using PR #1607's preview URL for testing
+This commit should be used in fork's main branch for testing only
+---
+ .github/workflows/pr-preview-links-on-comment.yml | 8 ++++++++
+ .github/workflows/pr-preview-links.yml            | 8 ++++++++
+ 2 files changed, 16 insertions(+)
+
+diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
+index f49cbc8e..b32db813 100644
+--- a/.github/workflows/pr-preview-links-on-comment.yml
++++ b/.github/workflows/pr-preview-links-on-comment.yml
+@@ -127,6 +127,14 @@ jobs:
+               return '';
+             }
+             
++            // TEMPORARY OVERRIDE FOR TESTING - Remove before production
++            const testingOverride = 'https://1607.docs-14y.pages.dev';
++            if (testingOverride) {
++              core.warning(`Using temporary testing override URL: ${testingOverride}`);
++              core.setOutput('branch_url', testingOverride);
++              return;
++            }
++            
+             const branchUrl = extractBranchPreviewUrl(context.payload.comment.body);
+             core.info(`Extracted Branch Preview URL: ${branchUrl}`);
+             core.setOutput('branch_url', branchUrl);
+diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
+index 1a08c2cb..a7729b48 100644
+--- a/.github/workflows/pr-preview-links.yml
++++ b/.github/workflows/pr-preview-links.yml
+@@ -220,6 +220,14 @@ jobs:
+               core.warning('Branch Preview URL not found within 2 minutes. Links will be added when Cloudflare comment triggers update workflow.');
+               return '';
+             }
++            // TEMPORARY OVERRIDE FOR TESTING - Remove before production
++            const testingOverride = 'https://1607.docs-14y.pages.dev';
++            if (testingOverride) {
++              core.warning(`Using temporary testing override URL: ${testingOverride}`);
++              core.setOutput('base', testingOverride);
++              return;
++            }
++            
+             let base = await waitForCloudflareBranchUrl();
+             if (!base) base = await fromOurExistingComment();
+             core.info(`Branch Preview URL found: ${base || '(not yet)'}`);
+-- 
+2.48.1
\ No newline at end of file
-- 
2.48.1


From eecfa9baf3f332573cd08ee59b2ee4a1b660ea1d Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Mon, 8 Sep 2025 23:44:19 +0000
Subject: [PATCH 4/5] Fix preview links and add temporary testing override

Co-authored-by: matt.linville <matt.linville@wandb.com>
---
 testing-override-clean.patch | 223 +++++++++++++++++++++++++++++++++++
 1 file changed, 223 insertions(+)
 create mode 100644 testing-override-clean.patch

diff --git a/testing-override-clean.patch b/testing-override-clean.patch
new file mode 100644
index 00000000..f533eb33
--- /dev/null
+++ b/testing-override-clean.patch
@@ -0,0 +1,223 @@
+From 589d391e9f5bb04dc63b5600b7ad1a12612718de Mon Sep 17 00:00:00 2001
+From: Cursor Agent <cursoragent@cursor.com>
+Date: Mon, 8 Sep 2025 22:20:51 +0000
+Subject: [PATCH 1/2] Fix preview workflow issues
+
+- Fix added files not being linked by checking out PR branch before Hugo build
+- Fix include file path construction when searching for dependent pages
+- Add special handling for index files in path mapping
+- Prevent deleted files from having preview links
+- Pass isDeleted flag to buildRows function to control link generation
+---
+ .../workflows/pr-preview-links-on-comment.yml | 23 ++++++++++++++-----
+ .github/workflows/pr-preview-links.yml        | 23 ++++++++++++++-----
+ 2 files changed, 34 insertions(+), 12 deletions(-)
+
+diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
+index 69c70f6f..f49cbc8e 100644
+--- a/.github/workflows/pr-preview-links-on-comment.yml
++++ b/.github/workflows/pr-preview-links-on-comment.yml
+@@ -84,6 +84,9 @@ jobs:
+       - name: Build Hugo (generate pageurls)
+         if: steps.changed.outputs.any_changed == 'true'
+         run: |
++          # Checkout the PR branch to get all changes including new files
++          git checkout ${{ steps.pr.outputs.head_sha }}
++          
+           hugo --minify
+           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
+ 
+@@ -267,6 +270,9 @@ jobs:
+                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
+                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
++                // Special handling for index files
++                path.posix.join('content', lang, '_index.md'),
++                path.posix.join('content', lang, 'index.md'),
+               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
+               
+               // Debug log for new pages
+@@ -325,8 +331,12 @@ jobs:
+               for (const page of pageMap) {
+                 if (page.path && page.path.endsWith('.md')) {
+                   try {
+-                    // Construct the correct file path: content/<lang>/<page.path>
+-                    const contentPath = path.join('content', page.lang || 'en', page.path);
++                    // Construct the correct file path
++                    // page.path might already include content/ prefix, so handle both cases
++                    let contentPath = page.path;
++                    if (!contentPath.startsWith('content/')) {
++                      contentPath = path.join('content', page.lang || 'en', page.path);
++                    }
+                     if (fs.existsSync(contentPath)) {
+                       const content = fs.readFileSync(contentPath, 'utf8');
+                       
+@@ -357,7 +367,7 @@ jobs:
+               return pagesUsingInclude;
+             }
+ 
+-            function buildRows(files) {
++            function buildRows(files, isDeleted = false) {
+               const rows = [];
+               
+               for (const fp of files) {
+@@ -388,7 +398,8 @@ jobs:
+                   } else {
+                     // Regular content file
+                     const e = mapEntry(fp);
+-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
++                    // Don't create links for deleted files
++                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
+                     const pathCell = '`' + e.path + '`';
+                     rows.push(`| ${titleCell} | ${pathCell} |`);
+                   }
+@@ -397,7 +408,7 @@ jobs:
+                   // Only link common web assets; skip JSON, map files, etc.
+                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
+                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
+-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
++                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
+                   const title = titleFromPath(fp);
+                   const titleCell = href ? `[${title}](${href})` : title;
+                   const pathCell = '`' + fp + '`';
+@@ -438,7 +449,7 @@ jobs:
+ 
+             const addedRows = buildRows(addedFiltered);
+             const modifiedRows = buildRows(modified);
+-            const deletedRows = buildRows(deletedFiltered);
++            const deletedRows = buildRows(deletedFiltered, true); // Pass true for deleted files
+             const renamedRows = buildRenamedRows(renamedFiles);
+ 
+             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + previewBase + ' -->\n**PR Preview: Changed content**\n\nBase preview: ' + previewBase;
+diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
+index 3ec72cb9..1a08c2cb 100644
+--- a/.github/workflows/pr-preview-links.yml
++++ b/.github/workflows/pr-preview-links.yml
+@@ -67,6 +67,9 @@ jobs:
+           echo "HEAD commit: $(git rev-parse HEAD)"
+           echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
+           
++          # First, checkout the PR branch to get all changes including new files
++          git checkout ${{ github.event.pull_request.head.sha }}
++          
+           hugo --minify
+           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
+           
+@@ -339,6 +342,9 @@ jobs:
+                 path.posix.join('content', lang, withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
+                 path.posix.join('content', withLang.endsWith('.md') ? withLang : withLang + '.md'),
+                 path.posix.join('content', withoutLang.endsWith('.md') ? withoutLang : withoutLang + '.md'),
++                // Special handling for index files
++                path.posix.join('content', lang, '_index.md'),
++                path.posix.join('content', lang, 'index.md'),
+               ].filter(Boolean).map(k => k.replace(/\\/g, '/')));
+               
+               // Debug log for new pages
+@@ -438,8 +444,12 @@ jobs:
+               for (const page of pageMap) {
+                 if (page.path && page.path.endsWith('.md')) {
+                   try {
+-                    // Construct the correct file path: content/<lang>/<page.path>
+-                    const contentPath = path.join('content', page.lang || 'en', page.path);
++                    // Construct the correct file path
++                    // page.path might already include content/ prefix, so handle both cases
++                    let contentPath = page.path;
++                    if (!contentPath.startsWith('content/')) {
++                      contentPath = path.join('content', page.lang || 'en', page.path);
++                    }
+                     if (fs.existsSync(contentPath)) {
+                       const content = fs.readFileSync(contentPath, 'utf8');
+                       
+@@ -470,7 +480,7 @@ jobs:
+               return pagesUsingInclude;
+             }
+ 
+-            function buildRows(files) {
++            function buildRows(files, isDeleted = false) {
+               const rows = [];
+               
+               for (const fp of files) {
+@@ -501,7 +511,8 @@ jobs:
+                   } else {
+                     // Regular content file
+                     const e = mapEntry(fp);
+-                    const titleCell = e.href ? `[${e.title}](${e.href})` : e.title;
++                    // Don't create links for deleted files
++                    const titleCell = (e.href && !isDeleted) ? `[${e.title}](${e.href})` : e.title;
+                     const pathCell = '`' + e.path + '`';
+                     rows.push(`| ${titleCell} | ${pathCell} |`);
+                   }
+@@ -510,7 +521,7 @@ jobs:
+                   // Only link common web assets; skip JSON, map files, etc.
+                   const isLinkableAsset = /\.(png|jpe?g|gif|webp|svg|css|js|ico|txt|pdf|mp4|webm)$/i.test(fp);
+                   const rel = fp.replace(/^static\//, '/').replace(/^assets\//, '/assets/');
+-                  const href = (previewBase && isLinkableAsset) ? (previewBase + rel) : '';
++                  const href = (previewBase && isLinkableAsset && !isDeleted) ? (previewBase + rel) : '';
+                   const title = titleFromPath(fp);
+                   const titleCell = href ? `[${title}](${href})` : title;
+                   const pathCell = '`' + fp + '`';
+@@ -605,7 +616,7 @@ jobs:
+ 
+             const addedRows = buildRows(addedInfo.files);
+             const modifiedRows = buildRows(modifiedInfo.files);
+-            const deletedRows = buildRows(deletedInfo.files);
++            const deletedRows = buildRows(deletedInfo.files, true); // Pass true for deleted files
+             const renamedRows = buildRenamedRows(renamedInfo.files);
+ 
+             const header = '<!-- docs-preview-links -->\n<!-- preview-base: ' + (previewBase || '') + ' -->\n**PR Preview: Changed content**' + (previewBase ? `\n\nBase preview: ${previewBase}` : '\n\n⏳ *Links will be added automatically when Cloudflare Pages finishes deploying (typically 2-5 minutes)*');
+-- 
+2.48.1
+
+
+From 7a3c2bb99bf644cc467f165f4d66732f12747b70 Mon Sep 17 00:00:00 2001
+From: Cursor Agent <cursoragent@cursor.com>
+Date: Mon, 8 Sep 2025 23:17:19 +0000
+Subject: [PATCH 2/2] Add temporary testing override for Cloudflare preview URL
+
+TEMPORARY: Using PR #1607's preview URL for testing
+This commit should be used in fork's main branch for testing only
+---
+ .github/workflows/pr-preview-links-on-comment.yml | 8 ++++++++
+ .github/workflows/pr-preview-links.yml            | 8 ++++++++
+ 2 files changed, 16 insertions(+)
+
+diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
+index f49cbc8e..b32db813 100644
+--- a/.github/workflows/pr-preview-links-on-comment.yml
++++ b/.github/workflows/pr-preview-links-on-comment.yml
+@@ -127,6 +127,14 @@ jobs:
+               return '';
+             }
+             
++            // TEMPORARY OVERRIDE FOR TESTING - Remove before production
++            const testingOverride = 'https://1607.docs-14y.pages.dev';
++            if (testingOverride) {
++              core.warning(`Using temporary testing override URL: ${testingOverride}`);
++              core.setOutput('branch_url', testingOverride);
++              return;
++            }
++            
+             const branchUrl = extractBranchPreviewUrl(context.payload.comment.body);
+             core.info(`Extracted Branch Preview URL: ${branchUrl}`);
+             core.setOutput('branch_url', branchUrl);
+diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
+index 1a08c2cb..a7729b48 100644
+--- a/.github/workflows/pr-preview-links.yml
++++ b/.github/workflows/pr-preview-links.yml
+@@ -220,6 +220,14 @@ jobs:
+               core.warning('Branch Preview URL not found within 2 minutes. Links will be added when Cloudflare comment triggers update workflow.');
+               return '';
+             }
++            // TEMPORARY OVERRIDE FOR TESTING - Remove before production
++            const testingOverride = 'https://1607.docs-14y.pages.dev';
++            if (testingOverride) {
++              core.warning(`Using temporary testing override URL: ${testingOverride}`);
++              core.setOutput('base', testingOverride);
++              return;
++            }
++            
+             let base = await waitForCloudflareBranchUrl();
+             if (!base) base = await fromOurExistingComment();
+             core.info(`Branch Preview URL found: ${base || '(not yet)'}`);
+-- 
+2.48.1
\ No newline at end of file
-- 
2.48.1


From a522f4ca7453efaf8a198461dbc0555c7a420d76 Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Tue, 9 Sep 2025 00:05:54 +0000
Subject: [PATCH 5/5] Additional fixes for preview workflow

- Checkout PR branch at the workflow level, not inside Hugo build
- Add fallback URL construction for new files not in pageurls.json
- Handle language-specific paths and _index.md files properly
---
 .../workflows/pr-preview-links-on-comment.yml | 44 ++++++++++++++-----
 .github/workflows/pr-preview-links.yml        | 32 +++++++++++---
 2 files changed, 59 insertions(+), 17 deletions(-)

diff --git a/.github/workflows/pr-preview-links-on-comment.yml b/.github/workflows/pr-preview-links-on-comment.yml
index f49cbc8e..546a9e7e 100644
--- a/.github/workflows/pr-preview-links-on-comment.yml
+++ b/.github/workflows/pr-preview-links-on-comment.yml
@@ -20,13 +20,6 @@ jobs:
     runs-on: ubuntu-latest
     
     steps:
-      - name: Checkout
-        uses: actions/checkout@v5
-        with:
-          fetch-depth: 0
-
-
-          
       - name: Get PR details
         id: pr
         uses: actions/github-script@v7
@@ -40,6 +33,12 @@ jobs:
             core.setOutput('head_sha', pr.data.head.sha);
             core.setOutput('base_sha', pr.data.base.sha);
             
+      - name: Checkout
+        uses: actions/checkout@v5
+        with:
+          fetch-depth: 0
+          ref: ${{ steps.pr.outputs.head_sha }}
+            
       - name: Setup Node.js
         uses: actions/setup-node@v5
         with:
@@ -84,9 +83,6 @@ jobs:
       - name: Build Hugo (generate pageurls)
         if: steps.changed.outputs.any_changed == 'true'
         run: |
-          # Checkout the PR branch to get all changes including new files
-          git checkout ${{ steps.pr.outputs.head_sha }}
-          
           hugo --minify
           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
 
@@ -297,9 +293,33 @@ jobs:
               if (!item) item = byPath.get(norm.replace(/^content\//, '').replace(/\.md$/, ''));
               
               // Debug log for unmatched files
-              if (!item && norm.includes('dspy')) {
+              if (!item) {
                 core.info(`Debug: Could not find mapping for ${norm}`);
-                core.info(`Debug: Available keys containing 'dspy': ${Array.from(byPath.keys()).filter(k => k.includes('dspy')).join(', ')}`);
+                // For new files, construct the URL based on the file path
+                if (norm.startsWith('content/') && norm.endsWith('.md')) {
+                  // Extract language and path
+                  const pathParts = norm.replace(/^content\//, '').replace(/\.md$/, '').split('/');
+                  let lang = 'en';
+                  let urlPath = pathParts.join('/');
+                  
+                  // Check if first part is a language code
+                  if (['en', 'ja', 'ko'].includes(pathParts[0])) {
+                    lang = pathParts[0];
+                    urlPath = pathParts.slice(1).join('/');
+                  }
+                  
+                  // Handle _index.md files
+                  if (urlPath.endsWith('/_index') || urlPath === '_index') {
+                    urlPath = urlPath.replace(/\/_index$/, '').replace(/^_index$/, '');
+                  }
+                  
+                  // Construct the URL
+                  const rel = lang === 'en' ? `/${urlPath}/` : `/${lang}/${urlPath}/`;
+                  const href = previewBase ? (previewBase.replace(/\/$/, '') + rel) : '';
+                  
+                  core.info(`Debug: Constructed URL for new file ${norm}: ${href}`);
+                  return { title: titleFromPath(norm), rel, href, path: norm };
+                }
               }
               
               if (!item) return { title: titleFromPath(norm), rel: '', href: '', path: norm };
diff --git a/.github/workflows/pr-preview-links.yml b/.github/workflows/pr-preview-links.yml
index 1a08c2cb..50d94b22 100644
--- a/.github/workflows/pr-preview-links.yml
+++ b/.github/workflows/pr-preview-links.yml
@@ -19,6 +19,7 @@ jobs:
         uses: actions/checkout@v5
         with:
           fetch-depth: 0
+          ref: ${{ github.event.pull_request.head.sha }}
 
       - name: Setup Node.js
         uses: actions/setup-node@v5
@@ -67,9 +68,6 @@ jobs:
           echo "HEAD commit: $(git rev-parse HEAD)"
           echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
           
-          # First, checkout the PR branch to get all changes including new files
-          git checkout ${{ github.event.pull_request.head.sha }}
-          
           hugo --minify
           test -f public/pageurls.json && echo "Found pageurls.json" || (echo "Missing pageurls.json" && ls -la public || true)
           
@@ -410,9 +408,33 @@ jobs:
               if (!item) item = byPath.get(norm.replace(/^content\//, '').replace(/\.md$/, ''));
               
               // Debug log for unmatched files
-              if (!item && norm.includes('dspy')) {
+              if (!item) {
                 core.info(`Debug: Could not find mapping for ${norm}`);
-                core.info(`Debug: Available keys containing 'dspy': ${Array.from(byPath.keys()).filter(k => k.includes('dspy')).join(', ')}`);
+                // For new files, construct the URL based on the file path
+                if (norm.startsWith('content/') && norm.endsWith('.md')) {
+                  // Extract language and path
+                  const pathParts = norm.replace(/^content\//, '').replace(/\.md$/, '').split('/');
+                  let lang = 'en';
+                  let urlPath = pathParts.join('/');
+                  
+                  // Check if first part is a language code
+                  if (['en', 'ja', 'ko'].includes(pathParts[0])) {
+                    lang = pathParts[0];
+                    urlPath = pathParts.slice(1).join('/');
+                  }
+                  
+                  // Handle _index.md files
+                  if (urlPath.endsWith('/_index') || urlPath === '_index') {
+                    urlPath = urlPath.replace(/\/_index$/, '').replace(/^_index$/, '');
+                  }
+                  
+                  // Construct the URL
+                  const rel = lang === 'en' ? `/${urlPath}/` : `/${lang}/${urlPath}/`;
+                  const href = previewBase ? (previewBase.replace(/\/$/, '') + rel) : '';
+                  
+                  core.info(`Debug: Constructed URL for new file ${norm}: ${href}`);
+                  return { title: titleFromPath(norm), rel, href, path: norm };
+                }
               }
               
               if (!item) return { title: titleFromPath(norm), rel: '', href: '', path: norm };
-- 
2.48.1

