---
title: エアギャップ環境（オフライン環境）向け Kubernetes operator
description: Kubernetes Operator を使用した W&B プラットフォームのデプロイ (エアギャップ環境)
---

import SelfManagedVersionRequirements from "/snippets/en/_includes/self-managed-version-requirements.mdx";
import SelfManagedSslTlsRequirements from "/snippets/en/_includes/self-managed-ssl-tls-requirements.mdx";
import SelfManagedMysqlRequirements from "/snippets/en/_includes/self-managed-mysql-requirements.mdx";
import SelfManagedMysqlDatabaseCreation from "/snippets/en/_includes/self-managed-mysql-database-creation.mdx";
import SelfManagedRedisRequirements from "/snippets/en/_includes/self-managed-redis-requirements.mdx";
import SelfManagedObjectStorageRequirements from "/snippets/en/_includes/self-managed-object-storage-requirements.mdx";
import SelfManagedHardwareRequirements from "/snippets/en/_includes/self-managed-hardware-requirements.mdx";
import SelfManagedVerifyInstallation from "/snippets/en/_includes/self-managed-verify-installation.mdx";

## はじめに

このガイドでは、エアギャップ（オフライン）環境のカスタマー管理環境に W&B プラットフォームをデプロイするための手順を詳しく説明します。

Helm チャートやコンテナイメージをホストするために、内部のリポジトリまたはレジストリを使用してください。すべてのコマンドは、Kubernetes クラスターへの適切なアクセス権限を持つシェルコンソールで実行してください。

Kubernetes アプリケーションのデプロイに使用している継続的デリバリー（CD）ツールでも、同様のコマンドを利用できます。

## ステップ 1: 前提条件

開始する前に、環境が以下の要件を満たしていることを確認してください。

### バージョン要件
<SelfManagedVersionRequirements/>

### SSL/TLS 要件
<SelfManagedSslTlsRequirements/>

### ハードウェア要件

<SelfManagedHardwareRequirements/>

### MySQL データベース

<SelfManagedMysqlRequirements/>

### Redis

<SelfManagedRedisRequirements/>

### オブジェクトストレージ

<SelfManagedObjectStorageRequirements/>

### 追加要件
- 必要な W&B イメージが含まれる内部コンテナレジストリへのアクセス
- W&B Helm チャート用の内部 Helm リポジトリへのアクセス

ネットワークやロードバランサーの設定を含むインフラストラクチャーの完全な要件については、[リファレンスアーキテクチャー](/platform/hosting/self-managed/ref-arch/#infrastructure-requirements)を参照してください。

<Note>
W&B はエアギャップ環境の OpenShift Kubernetes クラスターにデプロイ可能です。詳細は [リファレンスアーキテクチャー](/platform/hosting/self-managed/ref-arch/#kubernetes) を参照し、エアギャップ環境の OpenShift デプロイに適応可能な具体的な設定手順については、Operator ガイドの [OpenShift セクション](/platform/hosting/operator/#openshift-kubernetes-clusters) を確認してください。
</Note>

## ステップ 2: 内部コンテナレジストリの準備

エアギャップ環境へのデプロイを成功させるには、以下のコンテナイメージが内部コンテナレジストリで利用可能である必要があります。

W&B Operator の要件を追跡し、コンテナレジストリを最新のイメージで定期的に維持する責任はユーザーにあります。必要なコンテナイメージとバージョンの最新リストについては、Helm チャートを参照するか、[サポート](mailto:support@wandb.com) または担当の AISE にお問い合わせください。

### W&B コアコンポーネントコンテナ
* [`docker.io/wandb/controller`](https://hub.docker.com/r/wandb/controller)
* [`docker.io/wandb/local`](https://hub.docker.com/r/wandb/local)
* [`docker.io/wandb/console`](https://hub.docker.com/r/wandb/console)
* [`docker.io/wandb/megabinary`](https://hub.docker.com/r/wandb/megabinary)

### 依存関係

* [`docker.io/bitnamilegacy/redis`](https://hub.docker.com/r/bitnamilegacy/redis): テストおよび開発中のローカル Redis デプロイに必要です。ローカル Redis デプロイを使用する場合は、このイメージがコンテナレジストリで利用可能であることを確認してください。プロダクション環境の Redis 要件については、前提条件の [Redis セクション](#redis) を参照してください。
* [`docker.io/otel/opentelemetry-collector-contrib`](https://hub.docker.com/r/otel/opentelemetry-collector-contrib): W&B は、Kubernetes レイヤーのリソースからメトリクスとログを収集し、W&B 上で表示するために OpenTelemetry エージェントに依存しています。
* [`quay.io/prometheus/prometheus`](https://quay.io/repository/prometheus/prometheus): W&B は、さまざまなコンポーネントからメトリクスをキャプチャし、W&B 上で表示するために Prometheus に依存しています。
* [`quay.io/prometheus-operator/prometheus-config-reloader`](https://quay.io/repository/prometheus-operator/prometheus-config-reloader): Prometheus の必須の依存関係です。

### 必要なイメージの取得

Helm チャートの値から必要なイメージとバージョンの完全なリストを抽出するには：

1. [W&B Helm チャートリポジトリ](https://github.com/wandb/helm-charts)から、W&B Operator および Platform の Helm チャートをダウンロードします。

2. `values.yaml` ファイルを調査して、すべてのコンテナイメージとそのバージョンを特定します。

    ```bash
    # Helm チャートからイメージ参照を抽出
    helm show values wandb/operator \
      | awk -F': *' '/^[[:space:]]*repository:/{print $2}' \
      | grep -E '^wandb/' \
      | sort -u
    ```

    リストは以下のようになります。イメージのバージョンは異なる場合があります。

    ```text
    wandb/anaconda2
    wandb/console
    wandb/frontend-nginx
    wandb/local
    wandb/megabinary
    wandb/weave-python
    wandb/weave-trace
    ```

## ステップ 3: 内部 Helm チャートリポジトリの準備

コンテナイメージに加えて、以下の Helm チャートが内部 Helm チャートリポジトリで利用可能であることを確認する必要があります。以下からダウンロードしてください。

- [W&B Operator](https://github.com/wandb/helm-charts/tree/main/charts/operator)
- [W&B Platform](https://github.com/wandb/helm-charts/tree/main/charts/operator-wandb)

`operator` チャートは、コントローラーマネージャーとも呼ばれる W&B Operator をデプロイするために使用されます。`platform` チャートは、カスタムリソース定義（CRD）で設定された値を使用して W&B プラットフォームをデプロイするために使用されます。

## ステップ 4: Helm リポジトリのセットアップ

次に、内部リポジトリから W&B Helm チャートをプルするように Helm リポジトリを設定します。以下のコマンドを実行して、Helm リポジトリを追加し更新します。

```bash
helm repo add local-repo https://charts.yourdomain.com
helm repo update
```

## ステップ 5: Kubernetes Operator のインストール

コントローラーマネージャーとしても知られる W&B Kubernetes Operator は、W&B プラットフォームコンポーネントの管理を担当します。エアギャップ環境にインストールするには、内部コンテナレジストリを使用するように設定する必要があります。

そのためには、デフォルトのイメージ設定を上書きして内部コンテナレジストリを使用するようにし、キー `airgapped: true` を設定して想定されるデプロイタイプを示します。以下のように `values.yaml` ファイルを更新してください。

```yaml
image:
  repository: registry.yourdomain.com/library/controller
  tag: 1.13.3
airgapped: true
```

タグは内部レジストリで利用可能なバージョンに置き換えてください。

Operator と CRD をインストールします。
```bash
helm upgrade --install operator local-repo/operator -n wandb --create-namespace -f values.yaml
```

サポートされている値の詳細については、[Kubernetes Operator の GitHub リポジトリ](https://github.com/wandb/helm-charts/blob/main/charts/operator/values.yaml)を参照してください。

## ステップ 6: MySQL データベースのセットアップ

W&B カスタムリソースを設定する前に、外部 MySQL データベースをセットアップする必要があります。プロダクション環境のデプロイでは、W&B はマネージドデータベースサービスの使用を強く推奨します。ただし、独自の MySQL インスタンスを実行している場合は、データベースとユーザーを作成してください。

<SelfManagedMysqlDatabaseCreation/>

MySQL の設定パラメータについては、[リファレンスアーキテクチャーの MySQL 設定セクション](/platform/hosting/self-managed/ref-arch/#mysql-configuration-parameters)を参照してください。

## ステップ 7: W&B カスタムリソースの設定

W&B Kubernetes Operator をインストールした後、内部 Helm リポジトリとコンテナレジストリを指すようにカスタムリソース（CR）を設定する必要があります。

この設定により、W&B プラットフォームの必要なコンポーネントをデプロイする際に、Kubernetes Operator が内部のレジストリとリポジトリを使用するようになります。

この CR の例を `wandb.yaml` という名前の新しいファイルにコピーします。

```yaml
apiVersion: apps.wandb.com/v1
kind: WeightsAndBiases
metadata:
  labels:
    app.kubernetes.io/instance: wandb
    app.kubernetes.io/name: weightsandbiases
  name: wandb
  namespace: default

spec:
  chart:
    url: http://charts.yourdomain.com
    name: operator-wandb
    version: 0.18.0

  values:
    global:
      host: https://wandb.yourdomain.com
      license: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
      bucket:
        accessKey: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        secretKey: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        name: s3.yourdomain.com:port #例: s3.yourdomain.com:9000
        path: bucket_name
        provider: s3
        region: us-east-1
      mysql:
        database: wandb
        host: mysql.home.lab
        password: password
        port: 3306
        user: wandb
      redis:
        host: redis.yourdomain.com
        port: 6379
        password: password
      api:
        enabled: true
      glue:
        enabled: true
      executor:
        enabled: true
      extraEnv:
        ENABLE_REGISTRY_UI: 'true'

    app:
      image:
        repository: registry.yourdomain.com/local
        tag: 0.59.2

    console:
      image:
        repository: registry.yourdomain.com/console
        tag: 2.12.2

    api:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    executor:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    glue:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    parquet:
      image:
        repository: registry.yourdomain.com/megabinary
        tag: 0.59.2

    weave:
      image:
        repository: registry.yourdomain.com/weave-python
        tag: 0.59.2

    otel:
      image:
        repository: registry.yourdomain.com/otel/opentelemetry-collector-contrib
        tag: 0.97.0

    prometheus:
      server:
        image:
          repository: registry.yourdomain.com/prometheus/prometheus
          tag: v2.47.0
      configmapReload:
        prometheus:
          image:
            repository: registry.yourdomain.com/prometheus-operator/prometheus-config-reloader
            tag: v0.67.0

    ingress:
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: 0
      class: nginx

    
```

W&B プラットフォームをデプロイするために、Kubernetes Operator は CR からの値を使用して、内部リポジトリにある `operator-wandb` Helm チャートを設定します。

すべてのタグとバージョンを内部レジストリで利用可能なバージョンに置き換えてください。上記の例は、最も一般的に使用されるコンポーネントを示しています。デプロイのニーズに応じて、`settingsMigrationJob`、`weave-trace`、`filestream` などの追加コンポーネントのイメージレジストリを設定する必要がある場合もあります。設定可能なコンポーネントの完全なリストについては、[W&B Helm リポジトリの values ファイル](https://github.com/wandb/helm-charts/blob/main/charts/operator-wandb/values.yaml)を参照してください。

## ステップ 8: W&B プラットフォームのデプロイ

Kubernetes Operator と CR が設定されたので、`wandb.yaml` 設定を適用して W&B プラットフォームをデプロイします。

```bash
kubectl apply -f wandb.yaml
```

## ステップ 9: インストールの確認

<SelfManagedVerifyInstallation/>

## FAQ

デプロイプロセス中のよくある質問（FAQ）とトラブルシューティングのヒントについては、以下を参照してください。

### 別の ingress クラスがあります。そのクラスを使用できますか？
はい、`values.yaml` の ingress 設定を変更することで、独自の ingress クラスを設定できます。

### 証明書バンドルに複数の証明書が含まれています。動作しますか？
`values.yaml` の `customCACerts` セクションで、証明書を複数のエントリに分割する必要があります。

### Kubernetes Operator による意図しないアップデートを防ぐにはどうすればよいですか？可能ですか？
W&B コンソールから自動アップデートをオフにすることができます。サポートされているバージョンに関する質問については、W&B チームにお問い合わせください。W&B は、主要な W&B Server リリースを最初のリリース日から 12 か月間サポートします。**Self-Managed** インスタンスをご利用のお客様は、サポートを維持するために期限内にアップグレードする責任があります。サポートされていないバージョンのままにしないようにしてください。[リリースに関するポリシーとプロセス](/release-notes/release-policies)を参照してください。

<Note>
W&B は、サポートを維持し、最新の機能、パフォーマンスの向上、および修正を適用するために、**Self-Managed** インスタンスをご利用のお客様が少なくとも四半期に一度はデプロイを最新リリースにアップデートすることを強く推奨します。
</Note>

### 環境がパブリックリポジトリに接続されていない場合でもデプロイは機能しますか？
設定で `airgapped` を `true` に設定している場合、Kubernetes Operator は内部リソースのみを使用し、パブリックリポジトリへの接続を試みません。