---
title: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ Prod
description: W&B Weave ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æœ¬ç•ªç’°å¢ƒã§æ´»ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦å­¦ã³ã¾ã™
---

<Note>
ã“ã‚Œã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š
- [Google Colab ã§é–‹ã](https://colab.research.google.com/github/wandb/docs/blob/main/weave/cookbooks/source/feedback_prod.ipynb)
- [GitHub ã§ã‚½ãƒ¼ã‚¹ã‚’è¡¨ç¤º](https://github.com/wandb/docs/blob/main/weave/cookbooks/source/feedback_prod.ipynb)
</Note>

## 

ç”Ÿæˆã•ã‚ŒãŸ LLM ã®å¿œç­”ã‚’è‡ªå‹•çš„ã«è©•ä¾¡ã™ã‚‹ã“ã¨ã¯ã—ã°ã—ã°å›°é›£ã§ã™ã€‚ãã®ãŸã‚ã€è¨±å®¹ã§ãã‚‹ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã—ã€æ”¹å–„ã™ã¹ãç‚¹ã‚’è¦‹ã¤ã‘å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åé›†ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾‹ã¨ã—ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
Streamlit ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ã€LLM ã¨ã®ã‚„ã‚Šå–ã‚Šã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ Weave ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```python lines
!pip install weave openai streamlit wandb
!pip install set-env-colab-kaggle-dotenv -q # ç’°å¢ƒå¤‰æ•°ç”¨
python
# OpenAI ã¨ WandB ã® APIã‚­ãƒ¼ã‚’å«ã‚€ .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
from set_env import set_env

_ = set_env("OPENAI_API_KEY")
_ = set_env("WANDB_API_KEY")
```

æ¬¡ã«ã€ä»¥ä¸‹ã®å†…å®¹ã§ `chatbot.py` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```python lines {13,15,27}
# chatbot.py

import openai
import streamlit as st
import wandb
from set_env import set_env

import weave

_ = set_env("OPENAI_API_KEY")
_ = set_env("WANDB_API_KEY")

wandb.login()

weave_client = weave.init("feedback-example")
oai_client = openai.OpenAI()

def init_states():
    """session_state ã®ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚"""
    if "messages" not in st.session_state:
        st.session_state["messages"] = []
    if "calls" not in st.session_state:
        st.session_state["calls"] = []
    if "session_id" not in st.session_state:
        st.session_state["session_id"] = "123abc"

@weave.op
def chat_response(full_history):
    """
    ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´å…¨ä½“ã‚’å—ã‘å–ã‚Šã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§ OpenAI API ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
    full_history ã¯è¾æ›¸ã®ãƒªã‚¹ãƒˆã§ã™: [{"role":"user"|"assistant","content":...}, ...]
    """
    stream = oai_client.chat.completions.create(
        model="gpt-4", messages=full_history, stream=True
    )
    response_text = st.write_stream(stream)
    return {"response": response_text}

def render_feedback_buttons(call_idx):
    """call ã«å¯¾ã—ã¦ Good/Bad ãƒœã‚¿ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"""
    col1, col2, col3 = st.columns([1, 1, 4])

    # Good ãƒœã‚¿ãƒ³
    with col1:
        if st.button("ğŸ‘", key=f"thumbs_up_{call_idx}"):
            st.session_state.calls[call_idx].feedback.add_reaction("ğŸ‘")
            st.success("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼")

    # Bad ãƒœã‚¿ãƒ³
    with col2:
        if st.button("ğŸ‘", key=f"thumbs_down_{call_idx}"):
            st.session_state.calls[call_idx].feedback.add_reaction("ğŸ‘")
            st.success("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼")

    # ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    with col3:
        feedback_text = st.text_input("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯", key=f"feedback_input_{call_idx}")
        if (
            st.button("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡", key=f"submit_feedback_{call_idx}")
            and feedback_text
        ):
            st.session_state.calls[call_idx].feedback.add_note(feedback_text)
            st.success("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼")

def display_old_messages():
    """st.session_state.messages ã«ä¿å­˜ã•ã‚ŒãŸä¼šè©±ã‚’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã¨å…±ã«è¡¨ç¤ºã—ã¾ã™"""
    for idx, message in enumerate(st.session_state.messages):
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

            # ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            if message["role"] == "assistant":
                # st.session_state.calls å†…ã®ã“ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
                assistant_idx = (
                    len(
                        [
                            m
                            for m in st.session_state.messages[: idx + 1]
                            if m["role"] == "assistant"
                        ]
                    )
                    - 1
                )
                # Good/Bad ãƒœã‚¿ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                if assistant_idx < len(st.session_state.calls):
                    render_feedback_buttons(assistant_idx)

def display_chat_prompt():
    """ãƒãƒ£ãƒƒãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"""
    if prompt := st.chat_input("ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ï¼"):
        # æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³åº§ã«è¡¨ç¤º
        with st.chat_message("user"):
            st.markdown(prompt)

        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
        st.session_state.messages.append({"role": "user", "content": prompt})

        # API ç”¨ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æº–å‚™
        full_history = [
            {"role": msg["role"], "content": msg["content"]}
            for msg in st.session_state.messages
        ]

        with st.chat_message("assistant"):
            # ä¼šè©±ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ç”¨ã« Weave å±æ€§ã‚’ã‚¢ã‚¿ãƒƒãƒ
            with weave.attributes(
                {"session": st.session_state["session_id"], "env": "prod"}
            ):
                # OpenAI API ã‚’å‘¼ã³å‡ºã—ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰
                result, call = chat_response.call(full_history)

                # ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
                st.session_state.messages.append(
                    {"role": "assistant", "content": result["response"]}
                )

                # ç‰¹å®šã®å¿œç­”ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒªãƒ³ã‚¯ã•ã›ã‚‹ãŸã‚ã€weave ã® call ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜
                st.session_state.calls.append(call)

                # æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                new_assistant_idx = (
                    len(
                        [
                            m
                            for m in st.session_state.messages
                            if m["role"] == "assistant"
                        ]
                    )
                    - 1
                )

                # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if new_assistant_idx < len(st.session_state.calls):
                    render_feedback_buttons(new_assistant_idx)

def main():
    st.title("å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒ ä»˜ããƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ")
    init_states()
    display_old_messages()
    display_chat_prompt()

if __name__ == "__main__":
    main()
```

ã“ã‚Œã¯ `streamlit run chatbot.py` ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ“ä½œã—ã€å„å¿œç­”ã®å¾Œã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
Weave ã® UI ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## è§£èª¬

ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ã‘ãŸäºˆæ¸¬é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è€ƒãˆãŸå ´åˆï¼š

```python lines {5}
import weave

weave.init("feedback-example")

@weave.op
def predict(input_data):
    # ã“ã“ã«äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°
    some_result = "hello world"
    return some_result
```

é€šå¸¸é€šã‚Šã«ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’å±Šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python lines
with weave.attributes(
    {"session": "123abc", "env": "prod"}
):  # å…¥åŠ›ã¨å‡ºåŠ›ã¨å…±ã«ã€ä»»æ„ã®å±æ€§ã‚’ call ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™
    result = predict(input_data="your data here")  # ã‚¢ãƒ—ãƒª UI ã‚’é€šã˜ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•
```

ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã«ã¯ã€`call` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯ã€é€šå¸¸ã®ã‚ˆã†ã«é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã®ã§ã¯ãªãã€`.call()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å–å¾—ã§ãã¾ã™ã€‚

```python lines
result, call = predict.call(input_data="your data here")
```

ã“ã® call ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ç‰¹å®šã®å¿œç­”ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
å‘¼ã³å‡ºã—ã‚’è¡Œã£ãŸå¾Œã€æ“ä½œã®çµæœã¯ä¸Šè¨˜ã® `result` ã‚’ä½¿ã£ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

```python lines
call.feedback.add_reaction("ğŸ‘")  # ã‚¢ãƒ—ãƒª UI ã‚’é€šã˜ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
```

## ã¾ã¨ã‚

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Streamlit ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒƒãƒˆ UI ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚ã“ã® UI ã§ã¯ã€å…¥åŠ›ã¨å‡ºåŠ›ãŒ Weave ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œã€ã•ã‚‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹ãŸã‚ã® ğŸ‘ğŸ‘ ãƒœã‚¿ãƒ³ã‚‚å‚™ãˆã¦ã„ã¾ã™ã€‚