---
title: Models をログする
---
import { ColabLink } from '/snippets/en/_includes/colab-link.mdx';

<ColabLink url="https://colab.research.google.com/github/wandb/examples/blob/ken-add-new-model-reg-api/colabs/wandb-model-registry/New_Model_Logging_in_W&B.ipynb" />

# Models のログ記録

このガイドでは、W&B run に Models をログ記録し、それらを操作する方法について説明します。

<Note>
以下の API は、実験管理ワークフローの一部として Models を追跡するのに役立ちます。このページに記載されている API を使用して、run に Models をログ記録し、メトリクス、テーブル、メディア、その他のオブジェクトにアクセスしてください。

以下の場合は、[W&B Artifacts](/models/artifacts/) の使用を推奨します：
- Models 以外にも、データセットやプロンプトなど、シリアル化されたデータの異なるバージョンを作成・管理したい場合。
- W&B で追跡されているモデルやその他のオブジェクトの [リネージグラフ](/models/artifacts/explore-and-traverse-an-artifact-graph/) を確認したい場合。
- これらのメソッドによって作成されたモデルアーティファクトに対して、[プロパティの更新](/models/artifacts/update-an-artifact/)（メタデータ、エイリアス、説明文）などの操作を行いたい場合。

W&B Artifacts や高度なバージョン管理のユースケースに関する詳細は、[Artifacts](/models/artifacts/) のドキュメントを参照してください。
</Note>

## run へのモデルのログ記録
指定したディレクトリー内のコンテンツを含むモデルアーティファクトをログ記録するには、[`log_model`](/models/ref/python/experiments/run#log_model) を使用します。[`log_model`](/models/ref/python/experiments/run#log_model) メソッドは、生成されたモデルアーティファクトを W&B run の出力としてマークします。

モデルを W&B run の入力または出力としてマークすることで、モデルの依存関係や関連付けを追跡できます。モデルのリネージは W&B App の UI で確認できます。詳細については、[Artifacts](/models/artifacts/) チャプター内の [Explore and traverse artifact graphs](/models/artifacts/explore-and-traverse-an-artifact-graph/) ページを参照してください。

モデルファイルが保存されているパスを `path` パラメーターに指定します。パスには、ローカルファイル、ディレクトリー、または `s3://bucket/path` のような外部バケットへの [参照URI](/models/artifacts/track-external-files/#amazon-s3--gcs--azure-blob-storage-references) を指定できます。

`<>` で囲まれた値は、ご自身の環境の値に置き換えてください。

```python
import wandb

# W&B runを初期化
with wandb.init(project="<your-project>", entity="<your-entity>") as run:

    # モデルをログ記録
    run.log_model(path="<path-to-model>", name="<name>")
```

オプションで、`name` パラメーターにモデルアーティファクトの名前を指定できます。`name` が指定されない場合、W&B は入力パスのベース名に run ID をプレフィックスとして付けたものを名前として使用します。

<Note>
自身で設定した、あるいは W&B が割り当てた `name` を控えておいてください。[`wandb.Run.use_model()`](/models/ref/python/experiments/run#use_model) メソッドを使用してモデルのパスを取得する際に、そのモデル名が必要になります。
</Note>

パラメーターの詳細については、APIリファレンスの [`log_model`](/models/ref/python/experiments/run#log_model) を参照してください。

<details>

<summary>例：run へのモデルのログ記録</summary>

```python
import os
import wandb
from tensorflow import keras
from tensorflow.keras import layers

config = {"optimizer": "adam", "loss": "categorical_crossentropy"}

# W&B runを初期化
with wandb.init(entity="charlie", project="mnist-experiments", config=config) as run:

    # ハイパーパラメーター
    loss = run.config["loss"]
    optimizer = run.config["optimizer"]
    metrics = ["accuracy"]
    num_classes = 10
    input_shape = (28, 28, 1)

    # 学習アルゴリズム
    model = keras.Sequential(
        [
            layers.Input(shape=input_shape),
            layers.Conv2D(32, kernel_size=(3, 3), activation="relu"),
            layers.MaxPooling2D(pool_size=(2, 2)),
            layers.Conv2D(64, kernel_size=(3, 3), activation="relu"),
            layers.MaxPooling2D(pool_size=(2, 2)),
            layers.Flatten(),
            layers.Dropout(0.5),
            layers.Dense(num_classes, activation="softmax"),
        ]
    )

    # トレーニング用にモデルを設定
    model.compile(loss=loss, optimizer=optimizer, metrics=metrics)

    # モデルを保存
    model_filename = "model.h5"
    local_filepath = "./"
    full_path = os.path.join(local_filepath, model_filename)
    model.save(filepath=full_path)

    # W&B runにモデルをログ記録
    run.log_model(path=full_path, name="MNIST")
```

ユーザーが `log_model` を呼び出すと、`MNIST` という名前のモデルアーティファクトが作成され、ファイル `model.h5` がそのモデルアーティファクトに追加されます。ターミナルまたはノートブックには、モデルがログ記録された run の情報へのリンクが表示されます。

```python
View run different-surf-5 at: https://wandb.ai/charlie/mnist-experiments/runs/wlby6fuw
Synced 5 W&B file(s), 0 media file(s), 1 artifact file(s) and 0 other file(s)
Find logs at: ./wandb/run-20231206_103511-wlby6fuw/logs
```

</details>


## ログ記録されたモデルのダウンロードと使用
以前に W&B run にログ記録されたモデルファイルにアクセスしてダウンロードするには、[`use_model`](/models/ref/python/experiments/run#use_model) 関数を使用します。

取得したいモデルファイルが格納されているモデルアーティファクトの名前を指定します。指定する名前は、既存のログ記録されたモデルアーティファクトの名前と一致している必要があります。

`log_model` でファイルを最初にログ記録したときに `name` を定義しなかった場合、デフォルトで割り当てられる名前は、入力パスのベース名に run ID をプレフィックスとして付けたものになります。

`<>` で囲まれた値は、ご自身の環境の値に置き換えてください：
 
```python
import wandb

# runを初期化
with wandb.init(project="<your-project>", entity="<your-entity>") as run:

    # モデルにアクセスしてダウンロード。ダウンロードされたアーティファクトのパスを返す
    downloaded_model_path = run.use_model(name="<your-model-name>")
```

[use_model](/models/ref/python/experiments/run#use_model) 関数は、ダウンロードされたモデルファイルのパスを返します。後でこのモデルをリンクしたい場合に備えて、このパスを保持しておいてください。上記のコードスニペットでは、返されたパスは `downloaded_model_path` という変数に格納されています。

<details>

<summary>例：ログ記録されたモデルのダウンロードと使用</summary>

例えば、以下のコードスニペットでは、ユーザーが `use_model` API を呼び出しています。取得したいモデルアーティファクトの名前を指定し、バージョン/エイリアスも指定しています。その後、API から返されたパスを `downloaded_model_path` 変数に保存しています。

```python
import wandb

entity = "luka"
project = "NLP_Experiments"
alias = "latest"  # モデルバージョンのセマンティックなニックネームまたは識別子
model_artifact_name = "fine-tuned-model"

# runを初期化
with wandb.init(project=project, entity=entity) as run:
    # モデルにアクセスしてダウンロード。ダウンロードされたアーティファクトのパスを返す
    downloaded_model_path = run.use_model(name = f"{model_artifact_name}:{alias}") 
```
</details>

パラメーターと戻り値の型については、APIリファレンスの [`use_model`](/models/ref/python/experiments/run#use_model) を参照してください。