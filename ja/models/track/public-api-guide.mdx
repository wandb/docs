---
title: データのインポートとエクスポート
description: MLFlow から データをインポートしたり、 W&B に保存した データの書き出しや更新を行ったりします
---

import ApiKeyCreate from "/snippets/en/_includes/api-key-create.mdx";
import ApiKeySecurity from "/snippets/en/_includes/api-key-security.mdx";

W&B Public APIを使用して、データの構成やエクスポートを行うことができます。

<Note>
この機能には python>=3.8 が必要です。
</Note>

## MLFlow からのデータインポート

W&B は、Experiments 、Runs 、Artifacts 、メトリクス、その他のメタデータを含む MLFlow からのデータインポートをサポートしています。

依存関係のインストール:

```shell
# 注意: py38+ が必要です
pip install wandb[importers]
```

W&B にログインします。以前にログインしたことがない場合は、プロンプトに従ってください。

```shell
wandb login
```

既存の MLFlow サーバーからすべての Runs をインポートします：

```py
from wandb.apis.importers.mlflow import MlflowImporter

importer = MlflowImporter(mlflow_tracking_uri="...")

runs = importer.collect_runs()
importer.import_runs(runs)
```

デフォルトでは、`importer.collect_runs()` は MLFlow サーバーからすべての Runs を収集します。特定のサブセットをアップロードしたい場合は、独自の Runs イテラブルを構築してインポーターに渡すことができます。

```py
import mlflow
from wandb.apis.importers.mlflow import MlflowRun

client = mlflow.tracking.MlflowClient(mlflow_tracking_uri)

runs: Iterable[MlflowRun] = []
for run in mlflow_client.search_runs(...):
    runs.append(MlflowRun(run, client))

importer.import_runs(runs)
```

<Note>
Databricks MLFlow からインポートする場合は、まず [Databricks CLI を設定](https://docs.databricks.com/dev-tools/cli/index.html) する必要がある場合があります。

前のステップで `mlflow-tracking-uri="databricks"` を設定してください。
</Note>

Artifacts のインポートをスキップするには、`artifacts=False` を渡します：

```py
importer.import_runs(runs, artifacts=False)
```

特定の W&B Entity および Project にインポートするには、`Namespace` を渡すことができます：

```py
from wandb.apis.importers import Namespace

importer.import_runs(runs, namespace=Namespace(entity, project))
```

{/* Per DOCS-1043, hiding this information until it gets fixed 

## 別の W&B インスタンスからのデータインポート

<Note>
この機能はベータ版であり、W&B パブリッククラウドからのインポートのみをサポートしています。
</Note>

依存関係のインストール:

```sh
# 注意: py38+ が必要です
pip install wandb[importers]
```

ソースとなる W&B サーバーにログインします。以前にログインしたことがない場合は、プロンプトに従ってください。

```sh
wandb login
```

ソース W&B インスタンスからターゲット W&B インスタンスへ、すべての Runs と Artifacts をインポートします。Runs と Artifacts は、ターゲットインスタンスのそれぞれのネームスペースにインポートされます。

```py
from wandb.apis.importers.wandb import WandbImporter
from wandb.apis.importers import Namespace

importer = WandbImporter(
    src_base_url="https://api.wandb.ai",
    src_api_key="your-api-key-here",
    dst_base_url="https://example-target.wandb.io",
    dst_api_key="target-environment-api-key-here",
)

# "entity/project" (ソース) から "entity/project" (ターゲット) へ
# すべての Runs, Artifacts, Reports をインポートします
importer.import_all(namespaces=[
    Namespace(entity, project),
    # ... ここにネームスペースを追加
])
```

インポート先のネームスペースを変更したい場合は、`remapping: dict[Namespace, Namespace]` を指定できます。

```py
importer.import_all(
    namespaces=[Namespace(entity, project)],
    remapping={
        Namespace(entity, project): Namespace(new_entity, new_project),
    }
)
```

デフォルトでは、インポートは増分（incremental）で行われます。後続のインポートでは、以前の作業を検証し、成功/失敗を追跡する `.jsonl` ファイルに書き込みます。インポートが成功していれば、将来の検証はスキップされます。失敗した場合は再試行されます。この機能をオフにするには、`incremental=False` を設定します。

```py
importer.import_all(
    namespaces=[Namespace(entity, project)],
    incremental=False,
)
```

### 既知の問題と制限事項

- ターゲットのネームスペースが存在しない場合、W&B は自動的に作成します。
- ターゲットネームスペースに同じ ID の Run または Artifact が存在する場合、W&B はそれを増分インポートとして扱います。ターゲットの Run/Artifact は検証され、以前のインポートで失敗していた場合は再試行されます。
- ソースシステムからデータが削除されることはありません。

1. 一括インポート（特に大きな Artifacts）を行う際、S3 のレート制限に達することがあります。`botocore.exceptions.ClientError: An error occurred (SlowDown) when calling the PutObject operation` が表示された場合は、一度に移動するネームスペースの数を減らして、インポートの間隔を空けてみてください。
2. インポートされた Run テーブルは Workspace では空白に見えることがありますが、Artifacts タブに移動して該当する Run テーブル Artifact をクリックすると、期待通りに表示されます。
3. システムメトリクスとカスタムチャート（`run.log` で明示的にログ記録されていないもの）はインポートされません */}

## データのエクスポート

Public API を使用して、W&B に保存したデータのエクスポートや更新を行うことができます。この API を使用する前に、スクリプトからデータをログ記録してください。詳細は [クイックスタート](/models/quickstart/) を参照してください。

**Public API のユースケース**

- **データのエクスポート**: Jupyter Notebook でカスタム分析を行うためにデータフレームをプルします。データを探索した後は、新しい分析用 Run を作成して結果をログ記録することで、分析結果を同期できます。例: `wandb.init(job_type="analysis")`
- **既存の Runs の更新**: W&B Run に関連付けてログ記録されたデータを更新できます。例えば、アーキテクチャや当初ログ記録していなかったハイパーパラメータなどの追加情報を含めるために、一連の Runs の設定（config）を更新したい場合などです。

利用可能な関数の詳細については、[生成されたリファレンスドキュメント](/models/ref/python/public-api/) を参照してください。

### APIキーの作成

APIキーは、お使いのデバイスを W&B に対して認証します。

<ApiKeyCreate/>

<ApiKeySecurity/>

### Run パスの確認

Public API を使用するには、多くの場合 `<entity>/<project>/<run_id>` という形式の Run パスが必要になります。アプリの UI で Run ページを開き、[Overviewタブ ](/models/track/public-api-guide/#overview-tab)をクリックして Run パスを取得してください。

### Run データのダウンロード

完了した Run またはアクティブな Run からデータをダウンロードします。一般的な用途としては、Jupyter Notebook でのカスタム分析用にデータフレームをダウンロードしたり、自動化された環境でカスタムロジックを使用したりすることが挙げられます。

```python
import wandb

api = wandb.Api()
run = api.run("<entity>/<project>/<run_id>")
```

Run オブジェクトの最も一般的に使用される属性は以下の通りです：

| 属性 | 意味 |
| --- | --- |
| `run.config` | トレーニング Run のハイパーパラメータや、データセット Artifact を作成する Run の前処理メソッドなど、Run の設定情報の辞書です。これらは Run の「入力」と考えてください。 |
| `run.history()` | 損失（loss）など、モデルのトレーニング中に変化する値を格納するための辞書のリストです。`run.log()` コマンドはこのオブジェクトに値を追加します。 |
| `run.summary` | Run の結果を要約する情報の辞書です。精度（accuracy）や損失などのスカラー値、または大きなファイルが含まれます。デフォルトでは、`run.log()` はサマリーをログ記録された時系列データの最終値に設定します。サマリーの内容を直接設定することもできます。サマリーは Run の「出力」と考えてください。 |

過去の Runs のデータを修正または更新することも可能です。デフォルトでは、API オブジェクトの単一インスタンスがすべてのネットワークリクエストをキャッシュします。実行中のスクリプトでリアルタイムの情報が必要な場合は、`api.flush()` を呼び出して更新された値を取得してください。

### 各種 Run 属性の理解

以下のコードスニペットは、Run の作成、データのログ記録、そして Run 属性へのアクセス方法を示しています：

```python
import wandb
import random

with wandb.init(project="public-api-example") as run:
    n_epochs = 5
    config = {"n_epochs": n_epochs}
    run.config.update(config)
    for n in range(run.config.get("n_epochs")):
        run.log(
            {"val": random.randint(0, 1000), "loss": (random.randint(0, 1000) / 1000.00)}
        )
```

以下のセクションでは、上記の Run オブジェクト属性の各出力を説明します。

##### `run.config`

```python
{"n_epochs": 5}
```
    
#### `run.summary`

```python
{
    "_runtime": 4,
    "_step": 4,
    "_timestamp": 1644345412,
    "_wandb": {"runtime": 3},
    "loss": 0.041,
    "val": 525,
}
```

### サンプリング

デフォルトの `history` メソッドは、メトリクスを固定数にサンプリングします（デフォルトは 500 です。これは `samples` 引数で変更可能です）。大規模な Run のすべてのデータをエクスポートしたい場合は、`run.scan_history()` メソッドを使用できます。詳細は [API リファレンス](/models/ref/python/public-api) を参照してください。

### 複数の Runs へのクエリ

<Tabs>
<Tab title="DataFrame と CSV">
このサンプルスクリプトは、プロジェクト内の Runs を検索し、名前、config、サマリー統計を含む CSV を出力します。`<entity>` と `<project>` を、ご自身の W&B Entity と Project 名に置き換えてください。

```python
import pandas as pd
import wandb

api = wandb.Api()
entity, project = "<entity>", "<project>"
runs = api.runs(entity + "/" + project)

summary_list, config_list, name_list = [], [], []
for run in runs:
    # .summary には精度などのメトリクスの出力
    # キー/値が含まれます。
    # 大きなファイルを省くために ._json_dict を呼び出します
    summary_list.append(run.summary._json_dict)

    # .config にはハイパーパラメータが含まれます。
    # _ で始まる特殊な値を除外します。
    config_list.append({k: v for k, v in run.config.items() if not k.startswith("_")})

    # .name は Run の人間が読める名前です。
    name_list.append(run.name)

runs_df = pd.DataFrame(
    {"summary": summary_list, "config": config_list, "name": name_list}
)

runs_df.to_csv("project.csv")

run.finish()
```
</Tab>
<Tab title="MongoDB スタイル">
W&B API は、`api.runs()` を使用してプロジェクト内の Runs を横断的にクエリする方法も提供しています。最も一般的なユースケースは、カスタム分析のための Run データのエクスポートです。クエリインターフェースは [MongoDB が使用しているもの](https://docs.mongodb.com/manual/reference/operator/query) と同じです。

```python
runs = api.runs(
    "username/project",
    {"$or": [{"config.experiment_name": "foo"}, {"config.experiment_name": "bar"}]},
)
print(f"Found {len(runs)} runs")
```
</Tab>
</Tabs>

`api.runs` を呼び出すと、反復可能でリストのように動作する `Runs` オブジェクトが返されます。デフォルトでは、このオブジェクトは必要に応じて 50 個ずつの Runs を順次ロードしますが、`per_page` キーワード引数で 1 ページあたりのロード数を変更できます。

`api.runs` は `order` キーワード引数も受け取ります。デフォルトの順序は `-created_at` です。昇順にするには `+created_at` を指定します。また、config やサマリーの値でソートすることも可能です。例えば、`summary.val_acc` や `config.experiment_name` などです。

### エラーハンドリング

W&B サーバーとの通信中にエラーが発生した場合、`wandb.CommError` が発生します。元の例外は `exc` 属性を介して調査できます。

### API を介した最新の git コミットの取得

UI では、Run をクリックし、Run ページの Overview タブをクリックすると最新の git コミットを確認できます。また、`wandb-metadata.json` ファイルにも含まれています。Public API を使用すると、`run.commit` で git ハッシュを取得できます。

### Run 実行中の Run 名と ID の取得

`wandb.init()` を呼び出した後、スクリプトからランダムな Run ID または人間が読める Run 名にアクセスできます：

- ユニークな Run ID (8文字のハッシュ): `run.id`
- ランダムな Run 名 (人間が読める形式): `run.name`

Run に有用な識別子を設定する方法をお探しの場合は、以下を推奨します：

- **Run ID**: 生成されたハッシュのままにしておきます。これはプロジェクト内の Runs 全体で一意である必要があります。
- **Run 名**: チャート上の異なるラインを区別できるように、短くて読みやすく、できれば一意なものにしてください。
- **Run ノート**: Run で何を行っているかの簡単な説明を入れるのに最適です。`wandb.init(notes="ここにノートを記載")` で設定できます。
- **Run タグ**: Run タグで動的に追跡し、UI のフィルタを使用して関心のある Runs だけに絞り込みます。スクリプトからタグを設定し、その後 UI（Runs テーブルと Run ページの Overview タブの両方）で編集できます。詳細な手順は [こちら](/models/runs/tags/) を参照してください。

## Public API の例

### matplotlib や seaborn で可視化するためのデータエクスポート

一般的なエクスポートパターンについては、[API の例](/models/ref/python/public-api/) を確認してください。また、カスタムプロットや展開された Runs テーブルのダウンロードボタンをクリックして、ブラウザから CSV をダウンロードすることもできます。

### Run からのメトリクス読み取り

この例では、`"<entity>/<project>/<run_id>"` に保存された Run に対して、`run.log({"accuracy": acc})` で保存されたタイムスタンプと精度を出力します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
if run.state == "finished":
    for i, row in run.history().iterrows():
        print(row["_timestamp"], row["accuracy"])
```

### Runs のフィルタリング

MongoDB クエリ言語を使用してフィルタリングできます。

#### 日付

```python
runs = api.runs(
    "<entity>/<project>",
    {"$and": [{"created_at": {"$lt": "YYYY-MM-DDT##", "$gt": "YYYY-MM-DDT##"}}]},
)
```

### Run から特定のメトリクスを読み取る

Run から特定のメトリクスを取得するには、`keys` 引数を使用します。`run.history()` を使用する場合のデフォルトのサンプル数は 500 です。特定のメトリクスを含まないログステップは、出力データフレームで `NaN` として表示されます。`keys` 引数を使用すると、API はリストされたメトリクスキーを含むステップをより頻繁にサンプリングします。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
if run.state == "finished":
    for i, row in run.history(keys=["accuracy"]).iterrows():
        print(row["_timestamp"], row["accuracy"])
```

### 2 つの Runs の比較

これは `run1` と `run2` で異なる config パラメータを出力します。

```python
import pandas as pd
import wandb

api = wandb.Api()

# <entity>, <project>, <run_id> を置き換えてください
run1 = api.run("<entity>/<project>/<run_id>")
run2 = api.run("<entity>/<project>/<run_id>")


df = pd.DataFrame([run1.config, run2.config]).transpose()

df.columns = [run1.name, run2.name]
print(df[df[run1.name] != df[run2.name]])
```

出力例:

```
              c_10_sgd_0.025_0.01_long_switch base_adam_4_conv_2fc
batch_size                                 32                   16
n_conv_layers                               5                    4
optimizer                             rmsprop                 adam
```

### Run 終了後のメトリクス更新

この例では、以前の Run の精度を `0.9` に設定します。また、以前の Run の精度ヒストグラムを `numpy_array` のヒストグラムに変更します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
run.summary["accuracy"] = 0.9
run.summary["accuracy_histogram"] = wandb.Histogram(numpy_array)
run.summary.update()
```

### 完了した Run のメトリクス名の変更

この例では、テーブル内のサマリー列の名前を変更します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
run.summary["new_name"] = run.summary["old_name"]
del run.summary["old_name"]
run.summary.update()
```

<Note>
列名の変更はテーブルにのみ適用されます。チャートは引き続き元の名前でメトリクスを参照します。
</Note>

### 既存の Run の config 更新

この例では、設定項目の 1 つを更新します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
run.config["key"] = updated_value
run.update()
```

### システムリソース消費量（System metrics）の CSV エクスポート

以下のスニペットは、システムリソース消費量を取得し、CSV に保存します。

```python
import wandb

with wandb.Api().run("<entity>/<project>/<run_id>") as run:

    system_metrics = run.history(stream="events")
    system_metrics.to_csv("sys_metrics.csv")
```

### サンプリングされていないメトリクスデータの取得

ヒストリーからデータを取得する場合、デフォルトでは 500 ポイントにサンプリングされます。`run.scan_history()` を使用して、ログ記録されたすべてのデータポイントを取得します。以下は、ヒストリーにログ記録されたすべての `loss` データポイントをダウンロードする例です。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
history = run.scan_history()
losses = [row["loss"] for row in history]
```

### ヒストリーからのページ分割されたデータの取得

バックエンドでのメトリクス取得が遅い場合や API リクエストがタイムアウトする場合は、`scan_history` のページサイズを小さくして、個々のリクエストがタイムアウトしないように調整できます。デフォルトのページサイズは 500 です。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
run.scan_history(keys=sorted(cols), page_size=100)
```

### プロジェクト内のすべての Runs からメトリクスを CSV エクスポート

このスクリプトは、プロジェクト内の Runs をプルし、その名前、config、サマリー統計を含むデータフレームと CSV を生成します。`<entity>` と `<project>` をご自身の環境に合わせて置き換えてください。

```python
import pandas as pd
import wandb

api = wandb.Api()
entity, project = "<entity>", "<project>"
runs = api.runs(entity + "/" + project)

summary_list, config_list, name_list = [], [], []
for run in runs:
    # .summary には精度などのメトリクスの
    #  出力キー/値が含まれます。
    #  大きなファイルを省くために ._json_dict を呼び出します
    summary_list.append(run.summary._json_dict)

    # .config にはハイパーパラメータが含まれます。
    #  _ で始まる特殊な値を除外します。
    config_list.append({k: v for k, v in run.config.items() if not k.startswith("_")})

    # .name は Run の人間が読める名前です。
    name_list.append(run.name)

runs_df = pd.DataFrame(
    {"summary": summary_list, "config": config_list, "name": name_list}
)

runs_df.to_csv("project.csv")
```

### Run の開始時間の取得

このコードスニペットは、Run が作成された時間を取得します。

```python
import wandb

api = wandb.Api()

run = api.run("entity/project/run_id")
start_time = run.created_at
```

### 終了した Run へのファイルのアップロード

以下のコードスニペットは、選択したファイルを終了した Run にアップロードします。

```python
import wandb

api = wandb.Api()

run = api.run("entity/project/run_id")
run.upload_file("file_name.extension")
```

### Run からのファイルのダウンロード

これは cifar プロジェクトの Run ID uxte44z7 に関連付けられた "model-best.h5" ファイルを検索し、ローカルに保存します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
run.file("model-best.h5").download()
```

### Run からのすべてのファイルのダウンロード

これは Run に関連付けられたすべてのファイルを検索し、ローカルに保存します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
for file in run.files():
    file.download()
```

### 特定の Sweep からの Runs 取得

このスニペットは、特定の Sweep に関連付けられたすべての Runs をダウンロードします。

```python
import wandb

api = wandb.Api()

sweep = api.sweep("<entity>/<project>/<sweep_id>")
sweep_runs = sweep.runs
```

### Sweep からのベスト Run の取得

以下のスニペットは、指定した Sweep からベストな Run を取得します。

```python
import wandb

api = wandb.Api()

sweep = api.sweep("<entity>/<project>/<sweep_id>")
best_run = sweep.best_run()
```

`best_run` は、Sweep 設定の `metric` パラメータで定義された最高のメトリクスを持つ Run です。

### Sweep からのベストモデルファイルのダウンロード

このスニペットは、モデルファイルを `model.h5` として保存した Runs を持つ Sweep から、検証精度が最も高いモデルファイルをダウンロードします。

```python
import wandb

api = wandb.Api()

sweep = api.sweep("<entity>/<project>/<sweep_id>")
runs = sorted(sweep.runs, key=lambda run: run.summary.get("val_acc", 0), reverse=True)
val_acc = runs[0].summary.get("val_acc", 0)
print(f"Best run {runs[0].name} with {val_acc}% val accuracy")

runs[0].file("model.h5").download(replace=True)
print("Best model saved to model-best.h5")
```

### Run から特定の拡張子のすべてのファイルを削除

このスニペットは、Run から特定の拡張子を持つファイルを削除します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")

extension = ".png"
files = run.files()
for file in files:
    if file.name.endswith(extension):
        file.delete()
```

### システムメトリクスデータのダウンロード

このスニペットは、Run のすべてのシステムリソース消費メトリクスを含むデータフレームを生成し、CSV に保存します。

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")
system_metrics = run.history(stream="events")
system_metrics.to_csv("sys_metrics.csv")
```

### サマリーメトリクスの更新

辞書を渡してサマリーメトリクスを更新できます。

```python
summary.update({"key": val})
```

### Run を実行したコマンドの取得

各 Run は、その開始に使用されたコマンドを Run の Overview ページでキャプチャします。このコマンドを API から取得するには、以下を実行します：

```python
import wandb

api = wandb.Api()

run = api.run("<entity>/<project>/<run_id>")

meta = json.load(run.file("wandb-metadata.json").download())
program = ["python"] + [meta["program"]] + meta["args"]
```