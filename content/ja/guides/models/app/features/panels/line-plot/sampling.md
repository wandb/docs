---
title: ポイント集約
menu:
  default:
    identifier: ja-guides-models-app-features-panels-line-plot-sampling
    parent: line-plot
weight: 20
---

折れ線グラフ内でポイント集約メソッドを利用することで、データ可視化の精度とパフォーマンスを向上させることができます。ポイント集約モードには [フルフィデリティ]({{< relref path="#full-fidelity" lang="ja" >}}) と [ランダムサンプリング]({{< relref path="#random-sampling" lang="ja" >}}) の2種類があります。デフォルトでは W&B はフルフィデリティモードを使用します。

## フルフィデリティ

フルフィデリティモードでは、W&B は x 軸をデータポイント数に応じて動的にバケットに分割します。そのうえで各バケット内の最小値・最大値・平均値を計算し、折れ線グラフのポイント集約を描画します。

ポイント集約においてフルフィデリティモードを使用する主な利点は3つあります:

* 極端値やスパイクの保持：データ内の極端値やスパイクをそのまま保持します
* 最小・最大値の描画方法を設定可能：W&B App を使って極端値（最小/最大）をシェーディングして表示するかどうかをインタラクティブに決定できます
* データ精度を損なわずにデータ探索：特定のデータポイントにズームインすると、W&B が x 軸のバケットサイズを再計算します。これによって、精度を維持したままデータ探索を行うことが可能です。以前に計算した集約はキャッシュとして保存され、特に大規模な Dataset を扱う際の読み込み時間短縮に役立ちます。

### 最小・最大値の描画方法を設定

折れ線グラフの周囲にシェーディングを表示・非表示することで、最小値・最大値を強調できます。

以下の画像は青の折れ線グラフ例です。水色のシェーディング部分が各バケットの最小・最大値を表しています。

{{< img src="/images/app_ui/shaded-areas.png" alt="Shaded confidence areas" >}}

折れ線グラフ内で最小・最大値を描画する方法は3つあります:

* **Never**: 最小・最大値はシェーディングで表示されません。バケット全体の集約線のみが表示されます。
* **On hover**: グラフにマウスホバーした際に、動的に最小・最大値のシェーディングが現れます。視認性を損なわず、インタラクティブに範囲を確認できます。
* **Always**: グラフのすべてのバケットに対して常に最小・最大値のシェーディングが表示されます。値の全体的な範囲を常時把握できますが、複数の Run がある場合は可視化がにぎやかになることもあります。

デフォルトでは、最小・最大値はシェーディングされません。シェーディングありの表示方法を使いたい場合は下記の手順に従ってください。

{{< tabpane text=true >}}
{{% tab header="ワークスペース内の全チャートの場合" value="all_charts" %}}
1. お使いの W&B Project にアクセスします
2. 左タブの **Workspace** アイコンを選択します
3. 画面右上の **Add panels** ボタンの左隣にあるギアアイコンをクリックします
4. 表示される UI スライダーから **Line plots** を選択します
5. **Point aggregation** セクション内の「Show min/max values as a shaded area」ドロップダウンで **On hover** または **Always** を選択します
{{% /tab %}}

{{% tab header="ワークスペース内の個別チャートの場合" value="single_chart"%}}
1. お使いの W&B Project にアクセスします
2. 左タブの **Workspace** アイコンを選択します
3. フルフィデリティモードを有効にしたい折れ線グラフパネルを選択します
4. 表示されるモーダルで「Show min/max values as a shaded area」ドロップダウンから **On hover** または **Always** を選択します
{{% /tab %}}
{{< /tabpane >}}

### データ精度を損なわずにデータ探索

極端値やスパイクなど、重要なポイントを見逃さずに Dataset の特定の領域を分析できます。折れ線グラフでズームインすると、W&B はバケットサイズを調整し、各バケットで最小値・最大値・平均値を再計算します。

{{< img src="/images/app_ui/zoom_in.gif" alt="Plot zoom functionality" >}}

W&B はデフォルトで x 軸を動的に 1000 のバケットに分割します。各バケットには下記の値が計算されます：

- **Minimum**: バケット内での最小値
- **Maximum**: バケット内での最大値
- **Average**: バケット内の全ポイントの平均値

W&B はバケット内で値を描画する際、データの表現を完全に保ち、全てのグラフに極端値を反映します。1,000 ポイント以下にズームすると、フルフィデリティモードによって全ポイントが集約なしで表示されます。

折れ線グラフでズームインする方法:

1. お使いの W&B Project にアクセスします
2. 左タブの **Workspace** アイコンを選択します
3. ワークスペースに折れ線グラフパネルを追加するか、既存の折れ線グラフパネルに移動します
4. ズームしたい領域をクリック & ドラッグで選択します

{{% alert title="折れ線グラフのグループ化と式" %}}
折れ線グラフのグループ化を利用する場合、W&B は選択したモードに応じて下記を適用します：

- **非ウィンドウサンプリング (グルーピング)**: 複数の Run のポイントを x 軸上で整列させます。同じ x 値が複数存在する場合は平均、それ以外は個別のポイントとして表示されます。
- **ウィンドウサンプリング (グルーピングと式)**: x 軸を 250 バケットまたは一番長いラインのポイント数（少ない方）に分割します。各バケット内ポイントの平均を計算して表示します。
- **フルフィデリティ (グルーピングと式)**: 非ウィンドウサンプリングと同様ですが、Run 毎に最大 500 ポイントまで取得し、パフォーマンスと詳細表示のバランスを取ります。
{{% /alert %}}

## ランダムサンプリング

ランダムサンプリングでは折れ線グラフ描画のために 1500 個のポイントをランダムに抽出します。大量のデータポイントがある場合、パフォーマンス改善に役立ちます。

{{% alert color="warning" %}}
ランダムサンプリングは非決定的にサンプリングされます。そのため、重要な外れ値やスパイクが除外される場合があり、データの精度が下がる可能性があります。
{{% /alert %}}

### ランダムサンプリングの有効化
デフォルトでは W&B はフルフィデリティモードを使用します。ランダムサンプリングを有効にする場合、以下の手順を行ってください。

{{< tabpane text=true >}}
{{% tab header="ワークスペース内の全チャートの場合" value="all_charts" %}}
1. お使いの W&B Project にアクセスします
2. 左タブの **Workspace** アイコンを選択します
3. 画面右上の **Add panels** ボタンの左隣にあるギアアイコンをクリックします
4. 表示される UI スライダーから **Line plots** を選択します
5. **Point aggregation** セクションで **Random sampling** を選択します
{{% /tab %}}

{{% tab header="ワークスペース内の個別チャートの場合" value="single_chart"%}}
1. お使いの W&B Project にアクセスします
2. 左タブの **Workspace** アイコンを選択します
3. ランダムサンプリングを有効にしたい折れ線グラフパネルを選択します
4. 表示されるモーダルの **Point aggregation method** セクションで **Random sampling** を選択します
{{% /tab %}}
{{< /tabpane >}}

### サンプリングされていないデータへのアクセス

Run 中に記録されたメトリクスの完全な履歴には [W&B Run API]({{< relref path="/ref/python/public-api/runs.md" lang="ja" >}}) を使ってアクセスできます。以下は特定の Run から損失値を取得・処理する例です：

```python
# W&B API を初期化
run = api.run("l2k2/examples-numpy-boston/i0wt6xua")

# 'Loss' メトリクスの履歴を取得
history = run.scan_history(keys=["Loss"])

# 履歴から損失値のみ抽出
losses = [row["Loss"] for row in history]
```