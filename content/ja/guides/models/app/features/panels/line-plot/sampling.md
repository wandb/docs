---
title: ポイント集約
menu:
  default:
    identifier: sampling
    parent: line-plot
weight: 20
---

線グラフでポイント集約メソッドを活用することで、データ可視化の精度とパフォーマンスが向上します。ポイント集約モードには、[フルフィデリティ]({{< relref "#full-fidelity" >}}) と [ランダムサンプリング]({{< relref "#random-sampling" >}}) の 2 種類があります。W&B ではデフォルトでフルフィデリティモードが使用されます。

## フルフィデリティ

フルフィデリティモードでは、W&B が x 軸をデータポイント数に応じて動的にバケット分割します。各バケット内で最小値、最大値、平均値を計算し、その後、線グラフのポイント集約として描画します。

ポイント集約にフルフィデリティモードを使う主なメリットは 3 つあります：

* 極端値やスパイクを保持：データ内の極端な値やスパイクを保持できます
* 最小・最大ポイントの描画方法を設定：W&B App で、極値（最小/最大値）をシェーディングで表示するかインタラクティブに選べます
* データの精度を保ちつつ探索：特定のデータポイントまでズームインすると、W&B が自動で x 軸のバケットサイズを再計算し、精度を損なわずにデータを探索できます。キャッシュによって、過去に算出した集約結果も保存されるため、特に大規模なデータセットでは読み込み時間が短縮されます。

### 最小・最大ポイントの表示方法を設定

線グラフ周辺にシェーディングを加えることで、最小・最大値を表示・非表示にできます。

下図は青色の線グラフで、薄い青のシェード部分が各バケットの最小・最大値を示しています。

{{< img src="/images/app_ui/shaded-areas.png" alt="Shaded confidence areas" >}}

線グラフで最小・最大値を描画する方法は 3 種類あります：

* **Never**（表示しない）：最小・最大値はシェーディングで表示されません。x 軸バケットごとの集約線のみ表示されます。
* **On hover**（ホバー時）：チャート上で該当部分にカーソルを合わせると、そのときだけシェーディングが表示されます。この方法だと画面をすっきり保ったまま範囲の確認ができます。
* **Always**（常に表示）：すべてのバケットで最小・最大シェーディングが常時表示され、全体の値の幅を常に可視化できます。ただし、多数の run を同時に表示している場合は視覚的なノイズになることがあります。

デフォルトでは、最小・最大値はシェーディングで表示されません。いずれかの表示方法に変更するには、次の手順に従ってください。

{{< tabpane text=true >}}
{{% tab header="ワークスペース内のすべてのチャート" value="all_charts" %}}
1. W&B project にアクセスします
2. 左側タブの **Workspace** アイコンを選択します
3. 画面右上、**Add panels** ボタンの左隣にある歯車アイコンをクリック
4. 表示される UI スライダーから **Line plots** を選択
5. **Point aggregation** セクション内で、**Show min/max values as a shaded area** のドロップダウンから **On hover** または **Always** を選択
{{% /tab %}}

{{% tab header="ワークスペース内の個別チャート" value="single_chart"%}}
1. W&B project にアクセスします
2. 左側タブの **Workspace** アイコンを選択します
3. フルフィデリティモードを設定したい線グラフパネルを選択
4. 表示されるモーダル内で、**Show min/max values as a shaded area** のドロップダウンから **On hover** または **Always** を選択
{{% /tab %}}
{{< /tabpane >}}


### データの精度を保ちつつ探索

スパイクや極端な値といった重要ポイントを見逃すことなく、データセットの特定領域を分析できます。線グラフでズームインすると、W&B がバケットのサイズを自動調整し、そのバケット内での最小値・最大値・平均値を計算し直します。

{{< img src="/images/app_ui/zoom_in.gif" alt="Plot zoom functionality" >}}

W&B では、x 軸はデフォルトで動的に 1000 バケットに分割されます。各バケットごとに W&B は以下の値を計算します：

- **Minimum**：そのバケット内で最も小さい値
- **Maximum**：そのバケット内で最も大きい値
- **Average**：バケット内の全ポイントの平均値

W&B は、バケットごとに完全なデータ表現を維持するよう値を描画し、すべてのグラフに極端値も反映されます。1,000 ポイント以下にズームインした場合は、フルフィデリティモードにより全データポイントが追加集約なしで表示されます。

線グラフでズームインするには、下記の手順に従ってください。

1. W&B project にアクセスします
2. 左側タブの **Workspace** アイコンを選択します
3. 必要に応じて、ワークスペースに線グラフパネルを追加、もしくは既存の線グラフパネルに移動します
4. 拡大したい範囲をクリック＆ドラッグで選択します

{{% alert title="線グラフのグルーピングと式" %}}
Line Plot Grouping 使用時は、選択したモードによって W&B の挙動が変わります：

- **Non-windowed sampling（グルーピング）**：run 間で x 軸のポイントを揃えます。同じ x 値のポイントが複数ある場合は平均を取り、それ以外は個別のポイントとして表示します。
- **Windowed sampling（グルーピングと式）**：x 軸を 250 バケットまたは最長の線のポイント数（小さい方）で分割。各バケット内のポイントの平均を取ります。
- **Full fidelity（グルーピングと式）**：non-windowed sampling に近いですが、パフォーマンスと詳細表示のバランスをとるため run ごとに最大 500 ポイントを取得します。
{{% /alert %}}

## ランダムサンプリング

ランダムサンプリングでは、ランダムに 1500 ポイントをサンプリングし線グラフとして描画します。大量のデータポイントがある場合、パフォーマンス面で特に効果的です。

{{% alert color="warning" %}}
ランダムサンプリングは非決定的にサンプリングされます。つまり、重要な外れ値やスパイクが取り除かれることがあり、データ精度が下がる場合もあります。
{{% /alert %}}


### ランダムサンプリングを有効化する方法
デフォルトでは W&B はフルフィデリティモードを使用します。ランダムサンプリングに切り替えるには、次の手順を実行してください。

{{< tabpane text=true >}}
{{% tab header="ワークスペース内のすべてのチャート" value="all_charts" %}}
1. W&B project にアクセスします
2. 左側タブの **Workspace** アイコンを選択します
3. 画面右上、**Add panels** ボタンの左隣にある歯車アイコンをクリック
4. 表示される UI スライダーから **Line plots** を選択
5. **Point aggregation** セクション内で **Random sampling** を選択
{{% /tab %}}

{{% tab header="ワークスペース内の個別チャート" value="single_chart"%}}
1. W&B project にアクセスします
2. 左側タブの **Workspace** アイコンを選択します
3. ランダムサンプリングを設定したい線グラフパネルを選択
4. 表示されるモーダル内の **Point aggregation method** セクションで **Random sampling** を選択
{{% /tab %}}
{{< /tabpane >}}


### サンプリングされていないデータへアクセスする

run 中にログされた指標（メトリクス）の完全な履歴は、[W&B Run API]({{< relref "/ref/python/public-api/runs.md" >}}) を使って取得できます。以下は、特定の run の損失値を取得＆処理する例です。

```python
# W&B API を初期化
run = api.run("l2k2/examples-numpy-boston/i0wt6xua")

# 'Loss' メトリクスの履歴を取得
history = run.scan_history(keys=["Loss"])

# 履歴から損失値のみ抽出
losses = [row["Loss"] for row in history]
```